!function(t){"use strict";function e(t,e){Object.keys(e).forEach(function(n){for(var r=e[n];"function"!=typeof r;)r=e[r];if(!r)throw Error("The given key is not an operator: "+n);t[n]=r})}function n(t){if(null===E){t.init(),E=t.context.sampleRate,S=1/(60*E);x=i(r(t,O),j)}}function r(t,e){return Object.keys(e).reduce(function(n,r){var i=new t[r](e[r]).connect();return n[r]=i,n},{})}function i(t,e){return Object.keys(e).reduce(function(n,r){var i=e[r],s=t[i[0]];return n["@"+r]=o(s,i),n["@"+r+"-note"]=a(s,i),n},{})}function o(t,e){var n=c(e,4),r=(n[0],n[1]),i=n[2],o=n[3];return function(e){var n=e.scope;return o(t,n.get(r),n.get(i))}}function a(t,e){var n=c(e,4),r=(n[0],n[1],n[2]),i=n[3];return function(e){var n=e.stack;return i(t,n.pop(),r?n.pop():void 0)}}var s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},u=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),c=function(){function t(t,e){var n=[],r=!0,i=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(r=(a=s.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){i=!0,o=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw o}}return n}return function(e,n){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function t(e){s(this,t),this.parent=e,this.data=void 0}return u(t,[{key:"let",value:function(t,e){this.data||(this.data={}),this.data[t]=e}},{key:"ownsKey",value:function(t){return this.data&&void 0!==this.data[t]}},{key:"get",value:function(t){for(var e=this;e&&!e.ownsKey(t);)e=e.parent;return e&&e.data?e.data[t]:void 0}},{key:"set",value:function(t,e){for(var n=this;!n.ownsKey(t)&&n.parent;)n=n.parent;n.let(t,e)}}]),t}(),p=Array.isArray,f=function(t){return"string"==typeof t&&"@"===t[0]},l=function(){function t(e,n,r,i){s(this,t),this.scope=new h(e),this.stack=[],this.operations=[],this.time=r||0,this.rate=i||1,n&&this.operations.push(n)}return u(t,[{key:"wait",value:function(t){this.time+=this.rate*t}},{key:"step",value:function(t){var e=this.operations;if(e.length){var n=e.pop();if(null===n||void 0===n);else if(p(n))for(var r=n.length-1;r>=0;r--)e.push(n[r]);else f(n)?t.execute(n,this):this.stack.push(n)}}},{key:"resume",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;--n>0&&this.time<e&&this.operations.length;)this.step(t);if(0===n)throw Error("Run limit reached. Probably an infinite loop.");return this.operations.length>0}}]),t}(),v=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";s(this,t),this.name=n,this.nextId=0,this.scope=new h,this.operator=e,this.procs=[],this.time=0}return u(t,[{key:"tick",value:function(t){this.resume(this.time+t)}},{key:"resume",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=this.procs;--e>0&&this.at()<t;){var r=n.pop();r.resume(this.operator,t)&&this.schedule(r)}this.time=t}},{key:"at",value:function(){var t=this.procs.length;return t?this.procs[t-1].time:1/0}},{key:"run",value:function(t,e){return this.schedule(new l(this.scope,t,e,1))}},{key:"fork",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.schedule(new l(t.scope,e,t.time+n,1))}},{key:"schedule",value:function(t){if(t.scheduler=this,t.id||(t.id=this.name+"-"+this.nextId++),0===this.procs.length)this.procs.push(t);else{for(var e=this.procs.length-1,n=this.procs[e];n&&n.time<=t.time;)e--,n=this.procs[e];this.procs.splice(e+1,0,t)}return t}}]),t}(),d=Array.isArray,m={"@dup":function(t){var e=t.stack;return e.push(e.pop(e.length-1))},"@execute":function(t){var e=t.stack,n=e.pop();if("string"!=typeof n)throw Error("Trying to execute something that is not a string: "+n);e.push("@"+n)},"@":"@execute","@let":function(t){var e=t.stack;return t.scope.let(e.pop(),e.pop())},"@set":function(t){var e=t.stack;return t.scope.set(e.pop(),e.pop())},"@get":function(t){var e=t.stack,n=t.scope;return e.push(n.get(e.pop()))},"@wait":function(t){return t.wait(Math.abs(Number(t.stack.pop())))}},y={"@fork":function(t){var e=t.operations,n=t.scheduler,r=e.pop();if(!n)throw Error("Fork error - Can't fork a process without scheduler.");if(!d(r))throw Error("Fork error - not valid pattern: "+r);n.fork(t,r)}},k={"@repeat":function(t){var e=t.stack,n=t.operations,r=e.pop(),i=n[n.length-1];if(!d(i))throw Error("Can't repeat: "+i);for(var o=1;o<r;o++)n.push(i)}},g={"@print":function(t){var e=t.stack,n=e.length?e.pop():"<Empty Stack>";console.log("@print",n,"(id, time)",t.id,t.time)}},w=function(){function t(){var n=this;s(this,t),this.commands={};for(var r=arguments.length,i=Array(r),o=0;o<r;o++)i[o]=arguments[o];i.forEach(function(t){return e(n.commands,t)})}return u(t,[{key:"use",value:function(e){return new t(this.commands,e)}},{key:"execute",value:function(t,e){var n=this.commands[t];if(!n)throw Error("Operation not valid: "+t);return n(e)}}]),t}(),b=new w(m,y,k,g),E=null,S=null,x=null,A=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100;s(this,t),n(e),this.schedulers=[],this.commands=[],this.bpm=r,e.sequencers.push(this)}return u(t,[{key:"tick",value:function(t){for(;this.commands.length>0;){this.commands.shift()()}for(var e=this.schedulers.length,n=this.bpm*S,r=0;r<e;r++)this.schedulers[r].tick(n)}},{key:"start",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:b,n=e.use(x),r=new v(n);return r.run(t),this.schedulers.push(r),r}}]),t}(),O={Kick:{decay:.2},Snare:{snappy:1.5},Hat:{amp:1.5},Conga:{amp:.25,freq:400},Tom:{amp:.25,freq:400},PolyKarplusStrong:{maxVoices:32},MonoSynth:{attack:44,decay:.25,filterMult:.25,octave2:0,octave3:0}},q=function(t,e){return t.note(e)},K=function(t,e,n){return t.note(e,n)},M=function(t,e,n){n>0&&t.note(e,n)},T=function(t,e,n,r){n>0&&(t.damping=1- -6/Math.log(n/r),t.note(n,e*e*2))},j={pluck:["Pluck","amp","freq",T],bass:["Bass","amp","freq",M],kick:["Kick","amp",null,q],snare:["Snare","amp",null,q],hat:["Hat","amp",null,q],conga:["Conga","amp","freq",K],tom:["Tom","amp","freq",K]};t.Scope=h,t.Process=l,t.Scheduler=v,t.Operator=w,t.defaultOperator=b,t.Audio=A,t.process=m,t.schedule=y,t.repeat=k,t.debug=g}(this.ScheddVM=this.ScheddVM||{});
//# sourceMappingURL=ScheddVM.js.map

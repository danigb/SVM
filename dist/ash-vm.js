!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.AshVM=n.AshVM||{})}(this,function(n){"use strict";function t(n){return Object.keys(n).forEach(function(t){var e=n[t];m(e)&&(n[t]=n[e])}),n}function e(n){return{"@loop":function(t){var e=t.operations,r=t.error,o=e.pop();h(o)?n.fork(null,t,["@forever",o]):r("@loop",A,o)},"@fork":function(t){var e=t.operations,r=t.error,o=e.pop();h(o)?n.fork(null,t,o):r("@fork",A,o)},"@spawn":function(t){var e=t.stack,r=t.operations,o=t.error,i=e.pop(),a=r.pop();m(i)?h(a)?(n.stop(i),n.fork(i,t,["@forever",a])):o("@spawn",A,a):o("@spawn",j,i)},"@stop-all":function(t){return n.stopAll()},"@stop":function(t){var e=t.stack;return n.stop(e.pop())}}}function r(n,t){for(var e=t.length-1;e>=0&&t[e]!==n;)e--;e!==-1&&t.splice(e,1)}function o(n,t){if(0===t.length)t.push(n);else{for(var e=t.length-1,r=t[e];r&&r.time<=n.time;)e--,r=t[e];t.splice(e+1,0,n)}return n}function i(n){var t=n.length;return t?n[t-1].time:1/0}function a(n){n.context||n.init();var t=K(n);return t.instruments=u(T(n)),t.commands=V(t),n.sequencers.push(c(t)),function(n){return t.vms.push(n),n.audio=t,t.commands}}function u(n){return Object.keys(n).forEach(function(t){var e=n[t];if(!e.prepare){var r=e.params||[];e.prepare=function(n,t){r.forEach(function(e){var r=t.get(e);d(r)&&(n[e]=r)})}}}),n}function c(n){var t=n.vms,e=n.bpm2bpa;return{tick:function(){var r=n.vms.length;if(0!==r)for(var o=n.bpm*e,i=0;i<r;i++)t[i].resume(o)}}}function s(n){var t=n||Math.random,e=function(n){return _(t()*n)};return{"@random":function(n){return n.stack.push(t())},"@rand":"@random","@srandom":function(n){return n.stack.push(2*t()-1)},"@srand":"@srandom","@randi":function(n){var t=n.stack;return t.push(e(t.pop()))},"@pick":function(n){var t=n.operations,r=n.error,o=t.pop();if(h(o)){var i=e(o.length);t.push(o[i])}else t.push(o),r("Can't pick an element if is not an array",o)},"@chance":function(n){var e=n.stack,r=n.operations,o=e.pop(),i=r.pop();t()<o&&(r.pop(),r.push(i))}}}function p(n){return n=n||console.log.bind(console),{"@print":function(t){var e=t.stack;n("@print",e.length?y(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@log":function(t){var e=t.stack;n("@log",e.pop(),e.length?y(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@debug":function(t){n("@debug",t.stack,t.id,t.time)}}}function f(){return{"@pluck":z("pluck"),"@pluck-note":F("pluck","freq","amp"),"@bass":z("bass"),"@bass-note":F("bass","freq","amp"),"@hat":z("hat"),"@hat-note":F("hat","amp"),"@kick":z("kick"),"@kick-note":F("kick","amp"),"@snare":z("snare"),"@snare-note":F("snare","amp"),"@conga":z("conga"),"@conga-note":F("conga","amp"),"@clave":z("clave"),"@clave-note":F("clave","amp"),"@tom":z("tom"),"@tom-note":F("tom","amp")}}function l(n){var t=new P({amp:.5,freq:440});t.addCommands(a(n)),t.addCommands(s()),t.addCommands(p()),t.addCommands(f());for(var e=arguments.length,r=Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return r.forEach(function(n){return t.addCommands(n)}),t}var h=Array.isArray,m=function(n){return"string"==typeof n},v=function(n){return"function"==typeof n},d=function(n){return void 0!==n},k=function(n){return n[n.length-1]},y=k,g=function(n,t){return(n%t+t)%t},b=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},w=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),x=function(n){return"string"==typeof n&&"@"===n[0]},C=Array.isArray,q=1,E=function(){function n(t,e,r,o){b(this,n),this.id="proc-"+q++,this.stack=[],this.operations=t?[t]:[],this.context=new M(e),this.time="number"==typeof r?r:0,this.rate="number"==typeof o?o:1,this.error=this.error.bind(this)}return w(n,[{key:"wait",value:function(n){this.time+=this.rate*n}},{key:"step",value:function(n){var t=this.operations;if(t.length){var e=t.pop();if(null===e||void 0===e);else if("function"==typeof instruction)e();else if(C(e))for(var r=e.length-1;r>=0;r--)t.push(e[r]);else if(x(e)){var o=n[e];"function"==typeof o?o(this):this.error("","Instruction not recognized.",e)}else this.stack.push(e)}}},{key:"resume",value:function(n){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,r=this.operations;--e>0&&this.time<t&&r.length;)this.step(n);if(0===e)throw Error("Limit reached. Probably an infinity loop.");return r.length>0}},{key:"error",value:function(n,t,e){console.error(n,t,e,"id",this.id,"time",this.time)}}]),n}(),M=function(){function n(t){b(this,n),t instanceof n?this.parent=t:t&&(this.local=Object.assign({},t))}return w(n,[{key:"child",value:function(t){var e=new n(this);return e.local=Object.assign({},t),e}},{key:"get",value:function(n){for(var t=this;void 0===t.value(n)&&t.parent;)t=t.parent;return t.value(n)}},{key:"set",value:function(n,t){for(var e=this;void 0===e.value(n)&&e.parent;)e=e.parent;e.let(n,t)}},{key:"value",value:function(n){return this.local?this.local[n]:void 0}},{key:"let",value:function(n,t){this.local||(this.local={}),this.local[n]=t}}]),n}(),A="Expected a pattern, but found:",j="Expected a string, but found:",O=function(n){return function(t){var e=t.stack;e.push(n(e.pop()))}},N=function(n){return function(t){var e=t.stack;e.push(n(e.pop(),e.pop()))}},S={"@+":N(function(n,t){return t+n}),"@add":"@+","@-":N(function(n,t){return t-n}),"@sub":"@-","@*":N(function(n,t){return t*n}),"@mul":"@*","@/":N(function(n,t){return 0===n?0:t/n}),"@div":"@/","@%":N(function(n,t){return 0===n?0:g(t,n)}),"@wrap":"@%","@mod":N(function(n,t){return 0===n?0:t%n}),"@neg":O(function(n){return-n}),"@cond":function(n){var t=n.stack,e=n.operations,r=t.pop(),o=e.pop();r&&(e.pop(),e.push(o))},"@>":N(function(n,t){return t>n}),"@>=":N(function(n,t){return t>=n}),"@<":N(function(n,t){return t<n}),"@<=":N(function(n,t){return t<=n}),"@==":N(function(n,t){return t===n}),"@!=":N(function(n,t){return t!==n}),"@!":O(function(n){return!n}),"@not":"@!","@&&":N(function(n,t){return t&&n}),"@and":"@&&","@||":N(function(n,t){return t||n}),"@or":"@||","@let":function(n){var t=n.stack;return n.context.let(t.pop(),t.pop())},"@set":function(n){var t=n.stack;return n.context.set(t.pop(),t.pop())},"@get":function(n){var t=n.stack,e=n.context;return t.push(e.get(t.pop()))},"@wait":function(n){return n.wait(Math.abs(Number(n.stack.pop())))},"@sync":function(n){return n.wait(Math.floor(n.time)+1-n.time)},"@dup":function(n){var t=n.stack;return t.push(k(t))},"@execute":function(n){var t=n.operations,e=n.error,r=t.pop();m(r)?t.push("@instr"):e("@execute",j,r)},"@":"@execute","@repeat":function(n){var t=n.stack,e=n.operations,r=t.pop(),o=k(e);if(!h(o))throw Error("Can't repeat: "+o);for(var i=1;i<r;i++)e.push(o)},"@forever":function(n){var t=n.operations,e=k(t);if(!h(e))throw Error("Can't forover: "+e);e.length&&(t.push("@forever"),t.push(e))},"@iter":function(n){var t=n.operations,e=n.error,r=t.pop();if(h(r)&&r.length){var o=r.splice(0,1);t.push(o),r.push(o)}else e("@iter",A,r)},"@reverse":function(n){n.operations}},B=Object.assign,P=function(){function n(t){b(this,n),this.context=t,this.procs=[],this.procsByName={},this.time=0,this.commands=e(this),this.addCommands(S)}return w(n,[{key:"run",value:function(n){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.procs.length&&(n=["@sync",n]),this.fork(null,this.context,n)}},{key:"addCommands",value:function(n){v(n)&&(n=n(this)),n&&B(this.commands,t(n))}},{key:"fork",value:function(n,t,e){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4],a=this.time+r;!i&&t&&(i=t.rate);var u=t?t.context||t:void 0,c=new E(e,u,a,i);return o(c,this.procs),n&&(this.procsByName[n]=c),c}},{key:"resume",value:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,e=this.procs;if(0===e.length)return!1;for(var r=this.time+n;--t>0&&i(e)<r;){var a=e.pop();a.resume(this.commands,r)&&o(a,this.procs)}return this.time=r,e.length>0}},{key:"stopAll",value:function(){this.procs.length=0}},{key:"stop",value:function(n){if("string"==typeof n){var t=n;n=this.procsByName[t],this.procsByName[t]=null}r(n,this.procs)}}]),n}(),R=function(n){return'Instrument "'+n+'" not found.'},T=function(n){return{kick:{params:["amp","pitch","decay","tone"],init:function(){return new n.Kick({decay:.2}).connect()}},snare:{params:["amp","tune","cutoff","snappy"],init:function(){return new n.Snare({snappy:1.5}).connect()}},hat:{params:["amp","pitch"],init:function(){return new n.Hat({amp:1.5}).connect()}},conga:{params:["amp","pitch"],init:function(){return new n.Conga({amp:.25,freq:400}).connect()}},clave:{params:["amp","pitch"],init:function(){return new n.Clave({amp:1}).connect()}},tom:{params:["amp","pitch"],init:function(){return new n.Tom({amp:.25,freq:400}).connect()}},clap:{params:["amp"],init:function(){return new n.Clap({amp:.5}).connect()}},cowbell:{params:["amp","pitch"],init:function(){return new n.Cowbell({amp:.5}).connect()}},pluck:{params:["freq","amp","blend","damping","velocity"],init:function(){return new n.PolyKarplusStrong({maxVoices:32}).connect()},prepare:function(t,e){var r=e.get("freq");r>0&&(t.freq=r,t.damping=1- -6/Math.log(r/n.sampleRate));var o=e.get("amp");o&&(t.amp=o*o*.5);var i=e.get("blend");i&&(t.blend=i)}},bass:{params:["freq","amp","resonance"],init:function(){return new n.MonoSynth({attack:44,decay:n.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}},V=function(n){return{"@play":function(t){var e=t.context,r=t.error,o=I(e,n);o&&r("@play",o)},"@play-note":function(t){var e=t.stack,r=t.context,o=t.error,i=e.pop(),a=I(r.child(i),n);a&&o("@play-note",a)},"@bpm":function t(e){var r=e.stack,t=parseFloat(r.pop(),10);n.bpm=t}}},I=function(n,t){var e=t.instruments,r=n.get("inst"),o=e[r];if(!o)return R(r);o.instance||(o.instance=o.init());var i=o.instance;o.prepare(i,n),i.freq?i.note(i.freq):i.note()},K=function(n){return{Gibberish:n,bpm:100,sampleRate:n.context.sampleRate,bpm2bpa:1/(60*n.context.sampleRate),vms:[]}},_=Math.floor,z=function(n){return function(t){t.operations.push([{inst:n},"@play-note"])}},F=function(n,t,e){return function(r){var o=r.stack,i=r.operations,a={inst:n};e&&(a[e]=o.pop()),a[t]=o.pop(),i.push([a,"@play-note"])}};n.init=l,Object.defineProperty(n,"__esModule",{value:!0})});
//# sourceMappingURL=ash-vm.js.map

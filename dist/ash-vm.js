!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.AshVM=t.AshVM||{})}(this,function(t){"use strict";function e(t,e){for(var n=e.length-1;n>=0&&e[n]!==t;)n--;return n!==-1&&e.splice(n,1),n!==-1}function n(t,e){if(0===e.length)e.push(t);else{for(var n=e.length-1,r=e[n];r&&r.time<=t.time;)n--,r=e[n];e.splice(n+1,0,t)}return t}function r(t){var e=t.length;return e?t[e-1].time:1/0}function o(t,e){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return t.map(function(t){if(A(t))return o(t,e,n);if(!S(t))return t;var r=e.resolve(t);if(r)return r;if(n)throw Error("Command not found: "+t)})}function i(t){if("function"==typeof t)return t;if("object"===(void 0===t?"undefined":h(t)))return u(t);throw Error("Invalid operator: "+t)}function u(t){return function(e){var n=t[e];return"string"==typeof n?t[n]:n}}function s(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.random,n=e||Math.random,r=function(t){return Z(n()*t)},o=function(t){var n,r,o;for(o=t.length;o;o--)n=Z(e()*o),r=t[o-1],t[o-1]=t[n],t[n]=r};return{"@random":function(t){return t.stack.push(n())},"@rand":"@random","@srandom":function(t){return t.stack.push(2*n()-1)},"@srand":"@srandom","@randi":function(t){var e=t.stack;return e.push(r(e.pop()))},"@pick":function(t){var e=t.stack,n=t.error,o=e.pop();if(A(o)){var i=r(o.length);e.push(o[i])}else n("Can't pick an element if is not an array",o)},"@chance":function(t){var e=t.stack,r=t.operations,o=e.pop(),i=r.pop();n()<o&&(r.pop(),r.push(i))},"@shuffle":function(t){var e=t.stack,n=t.error,r=e.pop();A(r)?e.push(o(r)):n("@shuffle",N,r)}}}function a(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new P([F,V,K,z,Y,G(t),H(e),s(n),$(n),tt])}function c(t){return Object.keys(t).reduce(function(e,n){return e["@"+n]=function(e){var r=e.context;return t[n](r)},e},{})}function p(t){var e=new t.Kick({decay:.2}).connect(),n=new t.Snare({snappy:1.5}).connect(),r=new t.Hat({amp:1.5}).connect(),o=new t.Conga({amp:.25,freq:400}).connect(),i=new t.Tom({amp:.25,freq:400}).connect(),u=new t.PolyKarplusStrong({maxVoices:32}).connect(),s=new t.MonoSynth({attack:44,decay:t.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect(),a=t.sampleRate;return{kick:ot(e,.5),snare:ot(n,.25),hat:ot(r,1),conga:it(o,.25),tom:it(i,.25),pluck:function(t){var e=t.get("amp"),n=t.get("freq");n>0&&(u.damping=1- -6/Math.log(n/a),u.note(n,e*e*2))},bass:function(t){var e=t.get("amp"),n=t.get("freq");n>0&&s.note(n,e)}}}function f(t,e){return new et(new rt(t,e),e)}function l(t,e){}var h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},d=function(){function t(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e}}(),m=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var u=o.get;if(void 0!==u)return u.call(r)},y=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},g=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},k=function(){function t(e){v(this,t),e instanceof t?this.parent=e:e&&(this.local=Object.assign({},e))}return d(t,[{key:"child",value:function(e){var n=new t(this);return e&&(n.local=Object.assign({},e)),n}},{key:"get",value:function(t){for(var e=this;void 0===e.value(t)&&e.parent;)e=e.parent;return e.value(t)}},{key:"set",value:function(t,e){for(var n=this;void 0===n.value(t)&&n.parent;)n=n.parent;n.let(t,e)}},{key:"value",value:function(t){return this.local?this.local[t]:void 0}},{key:"let",value:function(t,e){this.local||(this.local={}),this.local[t]=e}}]),t}(),b=function(t){return"string"==typeof t&&"@"===t[0]},w=Array.isArray,x=1,O=function(){function t(e,n,r,o){v(this,t),this.id="proc-"+x++,this.stack=[],this.operations=e?[e]:[],this.context=new k(n),this.time="number"==typeof r?r:0,this.rate="number"==typeof o?o:1,this.error=this.error.bind(this)}return d(t,[{key:"wait",value:function(t){this.time+=this.rate*t}},{key:"step",value:function(t){var e=this.operations;if(e.length){var n=e.pop();if(null===n||void 0===n);else if("function"==typeof n)n(this);else if(w(n))for(var r=n.length-1;r>=0;r--)e.push(n[r]);else if(b(n)){var o=t.resolve(n);"function"==typeof o?o(this):this.error("step > ","Instruction not recognized.",n)}else this.stack.push(n)}}},{key:"resume",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,r=this.operations;--n>0&&this.time<e&&r.length;)this.step(t);if(0===n)throw Error("Limit reached. Probably an infinity loop.");return r.length>0}},{key:"error",value:function(t,e,n){console.error(t,e,n,"id",this.id,"time",this.time)}}]),t}(),E=function(t,e){return t[e]||(t[e]=[])},j=function(){function t(){v(this,t),this.all={}}return d(t,[{key:"register",value:function(t){var e=this;Object.keys(t).forEach(function(n){return e.on(n,t[n])})}},{key:"on",value:function(t,e){E(this.all,t).push(e)}},{key:"emit",value:function(t,e){E(this.all,t).map(function(t){return t(e)}),E(this.all,"*").map(function(n){return n(t,e)})}}]),t}(),_=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};v(this,t),this.procs=[],this.procsByName={},this.time=0,this.events=new j,e.events&&this.events.register(e.events)}return d(t,[{key:"fork",value:function(t,e,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4],u=this.time+o;!i&&e&&(i=e.rate);var s=e?e.context||e:void 0,a=new O(r,s,u,i);return n(a,this.procs),t&&(this.procsByName[t]=a),this.events.emit("fork",a),a}},{key:"resume",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,i=this.procs;if(i.length>0){for(var u=this.time+e;--o>0&&r(i)<u;){var s=i.pop();s.resume(t,u)?n(s,this.procs):this.events.emit("ended",{proc:s,time:this.time})}this.time=u}else this.time+=e;return i.length>0}},{key:"stopAll",value:function(){this.procs.length=0}},{key:"stop",value:function(t){var n=void 0;"string"==typeof n?(n=this.procsByName[t],this.procsByName[t]=null):(n=t,t=null),this.events.emit("stop",{proc:n}),e(n,this.procs)}}]),t}(),A=Array.isArray,I=function(t){return"string"==typeof t},q=function(t){return"number"==typeof t},M=function(t){return t[t.length-1]},C=M,S=function(t){return"string"==typeof t&&"@"===t[0]},P=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];v(this,t),this.operators=[],this.add(e)}return d(t,[{key:"add",value:function(t){if(A(t))for(var e=t.length;e--;)this.add(t[e]);else this.operators.push(i(t));return this}},{key:"resolve",value:function(t){for(var e=this.operators,n=e.length;n--;){var r=e[n](t);if(r)return r}}}]),t}(),D=function(t,e){return(t%e+e)%e},R=function(t){return function(e){var n=e.stack;n.push(t(n.pop()))}},T=function(t){return function(e){var n=e.stack;n.push(t(n.pop(),n.pop()))}},F={"@+":T(function(t,e){return e+t}),"@add":"@+","@-":T(function(t,e){return e-t}),"@sub":"@-","@*":T(function(t,e){return e*t}),"@mul":"@*","@/":T(function(t,e){return 0===t?0:e/t}),"@div":"@/","@%":T(function(t,e){return 0===t?0:D(e,t)}),"@wrap":"@%","@mod":T(function(t,e){return 0===t?0:e%t}),"@neg":R(function(t){return-t}),"@cond":function(t){var e=t.stack,n=t.operations,r=e.pop(),o=n.pop();r&&(n.pop(),n.push(o))},"@>":T(function(t,e){return e>t}),"@>=":T(function(t,e){return e>=t}),"@<":T(function(t,e){return e<t}),"@<=":T(function(t,e){return e<=t}),"@==":T(function(t,e){return e===t}),"@!=":T(function(t,e){return e!==t}),"@!":R(function(t){return!t}),"@not":"@!","@&&":T(function(t,e){return e&&t}),"@and":"@&&","@||":T(function(t,e){return e||t}),"@or":"@||"},N="Expected a pattern, but found:",B="Expected a iterable list, but found:",G=function(t){return{"@play":function(e){var n=e.context,r=e.error,o=n.get("voice"),i=t.instruments[o];i?i(n):r("@play","Instrument not found:",o)},"@set-bpm":function(e){var n=e.stack,r=parseFloat(n.pop(),10);r>0&&(t.bpm=r)},"@scale-tempo":function(e){var n=e.stack,r=parseFloat(n.pop(),10);r&&(t.bpm=t.bpm*r)}}},V={"@quote":function(t){var e=t.stack,n=t.operations,r=t.error,o=n.pop();A(o)?e.push(o):r("@list",B,o)},"@q":"@quote","@iter":function(t){var e=t.stack,n=t.error,r=e.pop();if(A(r)){var o=r.shift();e.push(o),r.push(o)}else n("@iter",B,r)},"@reverse":function(t){var e=t.stack,n=t.error,r=e.pop();A(r)?e.push(r.slice().reverse()):n("@reverse",B,r)},"@rotate":function(t){var e=t.stack,n=t.error,r=e.pop(),o=e.pop();if(A(o))if(q(r)){var i=r%o.length,u=[].concat(o.slice(i)).concat(o.slice(0,i));e.push(u)}else n("@rotate","Expected a number, but found:",r);else n("@rotate",B,o)}},K={"@dup":function(t){var e=t.stack;return e.push(M(e))},"@execute":function(t){var e=t.operations,n=t.error,r=e.pop();I(r)?e.push("@"+r):n("@execute","Expected a string, but found:",r)},"@":"@execute","@repeat":function(t){var e=t.stack,n=t.operations,r=t.error,o=e.pop(),i=M(n);if(A(i))for(var u=1;u<o;u++)n.push(i);else r("@repeat",N,i)},"@forever":function(t){var e=t.operations,n=t.error,r=M(e);A(r)&&r.length?(e.push("@forever"),e.push(r)):n("@forever",N,r)}},z={"@wait":function(t){return t.wait(Math.abs(Number(t.stack.pop())))},"@sync":function(t){return t.wait(Math.floor(t.time)+1-t.time)},"@scale-rate":function(t){var e=parseFloat(t.stack.pop(),10);e>0&&(t.rate*=e)},"@with-rate":function(t){var e=t.stack,n=t.operations,r=t.error,o=parseFloat(e.pop(),10),i=n.pop();A(i)||r("@with-rate",N,i),n.push([o,"@scale-rate",i,1/o,"@scale-rate"])}},H=function(t){return{"@loop":function(e){var n=e.operations,r=e.error,o=n.pop();A(o)?t.fork(null,e,["@forever",o]):r("@loop",N,o)},"@fork":function(e){var n=e.operations,r=e.error,o=n.pop();A(o)?t.fork(null,e,o):r("@fork",N,o)},"@spawn":function(e){var n=e.stack,r=e.operations,o=e.error,i=n.pop(),u=r.pop();I(i)?A(u)?(t.stop(i),t.fork(i,e,["@forever",u])):o("@spawn",N,u):o("@spawn","Expected a string, but found:",i)},"@stop-all":function(e){return t.stopAll()},"@stop":function(e){var n=e.stack;return t.stop(n.pop())}}},L=function(t){var e=t.stack;return t.context.let(e.pop(),e.pop())},W=function(t){var e=t.stack;return t.context.set(e.pop(),e.pop())},J=function(t){var e=t.stack,n=t.context;return e.push(n.get(e.pop()))},Q=function(t){return function(e){var n=e.stack;return e.context.let(t,n.pop())}},U=function(t){return function(e){var n=e.stack;return e.context.set(t,n.pop())}},X=function(t){return function(e){var n=e.stack,r=e.context;return n.push(r.get(t))}},Y=function(t){return"@let"===t?L:"@set"===t?W:"@get"===t?J:/^@let-.+/.exec(t)?Q(t.slice(5)):/^@set-.+/.exec(t)?U(t.slice(5)):/^@get-.+/.exec(t)?X(t.slice(5)):void 0},Z=Math.floor,$=function(t){var e=t.log;return e=e||console.log.bind(console),{"@print":function(t){var n=t.stack;e("@print",n.length?C(n):"<Empty Stack>","(id, time)",t.id,t.time)},"@log":function(t){var n=t.stack;e("@log",n.pop(),n.length?C(n):"<Empty Stack>","(id, time)",t.id,t.time)},"@debug":function(t){e("@debug",t.stack,t.id,t.time)}}},tt={"@mtof":function(t){var e=t.stack,n=e.pop(),r=440*Math.pow(2,(+n-69)/12);e.push(r)},"@linear":function(t){var e=t.stack,n=e.pop(),r=e.pop(),o=e.pop(),i=e.pop(),u=e.pop();o===i?e.push(r):e.push(r+(u-i)/(o-i)*(n-r))}},et=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};v(this,t),this.context={},this.driver=e,this.scheduler=new _(n),this.commands=a(this.driver,this.scheduler,n),e&&(this.addToContext(e.defaultContext()),this.commands.add(c(e.getInstruments())),e.start(this)),n.commands&&this.addCommands(n.commands)}return d(t,[{key:"addInstruments",value:function(t){console.log("ADDDDDIIII",t),this.driver.addInstruments(t),this.commands.add(c(t))}},{key:"run",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.scheduler;e&&n.procs.length&&(t=["@sync",t]);var r=o(t,this.commands,!0);return n.fork(null,this.context,r)}},{key:"resume",value:function(t,e){return this.scheduler.resume(this.commands,t,e)}},{key:"addCommands",value:function(t){return this.commands.add(t),this}},{key:"addToContext",value:function(t){return Object.assign(this.context,t),this.context}}]),t}(),nt=function(){function t(e,n){if(v(this,t),!e)throw Error("AudioDriver bpm is required");if(!n)throw Error("AudioDriver sampleRate is required");this.bpm=e,this.sampleRate=n,this.instruments={}}return d(t,[{key:"addInstruments",value:function(t){return Object.assign(this.instruments,t),this.instruments}},{key:"getInstruments",value:function(){return this.instruments}},{key:"defaultContext",value:function(){return{freq:440,amp:.5}}},{key:"start",value:function(t){if(this.scheduler)throw Error("Can't attach an audio driver twice");if(t.audio)throw Error("The given scheduler has an audio driver already");this.scheduler=t,t.audio=this}}]),t}(),rt=function(t){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=n.bpm,o=void 0===r?100:r;v(this,e),t.context||t.init();var i=g(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,o,t.context.sampleRate));return i.Gibberish=t,i.instruments=p(t),console.log("MIERDA",i.instruments),i}return y(e,t),d(e,[{key:"start",value:function(t){var n=this;m(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"start",this).call(this,t);var r=1/(60*this.sampleRate),o=function(){t.resume(n.bpm*r)};this.Gibberish.sequencers.push({tick:o})}}]),e}(nt),ot=function(t,e){return function(n){t.amp=e*n.get("amp"),t.note()}},it=function(t,e){return function(n){t.amp=e*n.get("amp"),t.pitch=n.get("freq"),t.note()}};t.initGibberish=f,t.initWebAudio=l,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ash-vm.js.map

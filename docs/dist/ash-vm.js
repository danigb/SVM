!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.AshVM=t.AshVM||{})}(this,function(t){"use strict";function n(t,n){setTimeout(function(){t(n)},0)}function e(t){return{"@loop":function(n){var e=n.operations,r=n.error,o=e.pop();k(o)?t.fork(null,n,["@forever",o]):r("@loop",R,o)},"@fork":function(n){var e=n.operations,r=n.error,o=e.pop();k(o)?t.fork(null,n,o):r("@fork",R,o)},"@spawn":function(n){var e=n.stack,r=n.operations,o=n.error,i=e.pop(),a=r.pop();y(i)?k(a)?(t.stop(i),t.fork(i,n,["@forever",a])):o("@spawn",R,a):o("@spawn",V,i)},"@stop-all":function(n){return t.stopAll()},"@stop":function(n){var e=n.stack;return t.stop(e.pop())}}}function r(t,n){for(var e=n.length-1;e>=0&&n[e]!==t;)e--;return e!==-1&&n.splice(e,1),e!==-1}function o(t,n){if(0===n.length)n.push(t);else{for(var e=n.length-1,r=n[e];r&&r.time<=t.time;)e--,r=n[e];n.splice(e+1,0,t)}return t}function i(t){var n=t.length;return n?t[n-1].time:1/0}function a(t){return Object.keys(t).forEach(function(n){var e=t[n];y(e)&&(t[n]=t[e])}),t}function u(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.context||t.init();var e=new G(t,n.bpm||120);return e.addInstruments(s(t)),e}function s(t){var n=new t.Kick({decay:.2}).connect(),e=new t.Snare({snappy:1.5}).connect(),r=new t.Hat({amp:1.5}).connect(),o=new t.Conga({amp:.25,freq:400}).connect(),i=new t.Tom({amp:.25,freq:400}).connect(),a=new t.PolyKarplusStrong({maxVoices:32}).connect(),u=new t.MonoSynth({attack:44,decay:t.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect(),s=t.sampleRate;return{kick:z(n,.5),snare:z(e,.25),hat:z(r,1),conga:D(o,.25),tom:D(i,.25),pluck:function(t){var n=t.get("amp"),e=t.get("freq");e>0&&(a.damping=1- -6/Math.log(e/s),a.note(e,n*n*2))},bass:function(t){var n=t.get("amp"),e=t.get("freq");e>0&&u.note(e,n)}}}function c(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=t||new AudioContext;var e=new L(t,n.bpm||120);return e.addInstruments(W(t)),e}function p(t,n,e){var r=e||.1,o=r/3,i=t.currentTime+r,a=function(){t.currentTime+r>=i&&(n(i),i+=r)};return a(),setInterval(a,o)}function f(t,n,e,r,o){var i=t.createOscillator();return i.frequency.value=e||200,i.amp=t.createGain(),i.amp.gain.value=0,i.connect(i.amp),i.amp.connect(t.destination),i.start(n),i.amp.gain.setValueAtTime(0,n),i.amp.gain.linearRampToValueAtTime(.5*r,n+.01),i.amp.gain.linearRampToValueAtTime(0,n+o),i.stop(n+o+.1),i}function l(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.random,e=n||Math.random,r=function(t){return Y(e()*t)},o=function(t){var e,r,o;for(o=t.length;o;o--)e=Y(n()*o),r=t[o-1],t[o-1]=t[e],t[e]=r};return{"@random":function(t){return t.stack.push(e())},"@rand":"@random","@srandom":function(t){return t.stack.push(2*e()-1)},"@srand":"@srandom","@randi":function(t){var n=t.stack;return n.push(r(n.pop()))},"@pick":function(t){var n=t.operations,e=t.error,o=n.pop();if(k(o)){var i=r(o.length);n.push(o[i])}else n.push(o),e("Can't pick an element if is not an array",o)},"@chance":function(t){var n=t.stack,r=t.operations,o=n.pop(),i=r.pop();e()<o&&(r.pop(),r.push(i))},"@shuffle":function(t){var n=(t.stack,t.operations),e=t.error,r=n.pop();k(r)?n.push(o(r)):e("@shuffle",R,r)}}}function h(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.log;return n=n||console.log.bind(console),{"@print":function(t){var e=t.stack;n("@print",e.length?x(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@log":function(t){var e=t.stack;n("@log",e.pop(),e.length?x(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@debug":function(t){n("@debug",t.stack,t.id,t.time)}}}function m(){return{"@set-freq":function(t){var n=t.context,e=t.stack;return n.set("freq",e.pop())},"@set-amp":function(t){var n=t.context,e=t.stack;return n.set("amp",e.pop())},"@get-freq":function(t){var n=t.stack,e=t.context;return n.push(e.get("freq"))},"@get-amp":function(t){var n=t.stack,e=t.context;return n.push(e.get("amp"))},"@reverse":function(t){var n=t.operations,e=t.error,r=n.pop();k(r)?n.push(r.slice().reverse()):e("@reverse",R,r)},"@map":"@linear","@pluck":Z("pluck"),"@pluck-note":$("pluck","freq","amp"),"@bass":Z("bass"),"@bass-note":$("bass","freq","amp"),"@hat":Z("hat"),"@hat-note":$("hat","amp"),"@kick":Z("kick"),"@kick-note":$("kick","amp"),"@snare":Z("snare"),"@snare-note":$("snare","amp"),"@conga":Z("conga"),"@conga-note":$("conga","amp"),"@clave":Z("clave"),"@clave-note":$("clave","amp"),"@tom":Z("tom"),"@tom-note":$("tom","amp")}}function v(t,n){return g(u,t,n)}function d(t,n){return g(c,t,n)}function g(t,n){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=e.plugins,o=new S(e);return t(n,e).start(o),o.addCommands(X),o.addCommands(l(e)),o.addCommands(h(e)),o.addCommands(m(e)),r&&r.forEach(function(t){return o.addCommands(t)}),o}var k=Array.isArray,y=function(t){return"string"==typeof t},b=function(t){return"function"==typeof t},w=function(t){return t[t.length-1]},x=w,O=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},_=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),j=function t(n,e,r){null===n&&(n=Function.prototype);var o=Object.getOwnPropertyDescriptor(n,e);if(void 0===o){var i=Object.getPrototypeOf(n);return null===i?void 0:t(i,e,r)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(r)},q=function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)},A=function(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n},C=function(t){return"string"==typeof t&&"@"===t[0]},E=Array.isArray,T=1,M=function(){function t(n,e,r,o){O(this,t),this.id="proc-"+T++,this.stack=[],this.operations=n?[n]:[],this.context=new P(e),this.time="number"==typeof r?r:0,this.rate="number"==typeof o?o:1,this.error=this.error.bind(this)}return _(t,[{key:"wait",value:function(t){this.time+=this.rate*t}},{key:"step",value:function(t){var e=this.operations;if(e.length){var r=e.pop();if(null===r||void 0===r);else if("function"==typeof r)n(r,this.time);else if(E(r))for(var o=r.length-1;o>=0;o--)e.push(r[o]);else if(C(r)){var i=t[r];"function"==typeof i?i(this):this.error("step > ","Instruction not recognized.",r)}else this.stack.push(r)}}},{key:"resume",value:function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,r=this.operations;--e>0&&this.time<n&&r.length;)this.step(t);if(0===e)throw Error("Limit reached. Probably an infinity loop.");return r.length>0}},{key:"error",value:function(t,n,e){console.error(t,n,e,"id",this.id,"time",this.time)}}]),t}(),P=function(){function t(n){O(this,t),n instanceof t?this.parent=n:n&&(this.local=Object.assign({},n))}return _(t,[{key:"child",value:function(n){var e=new t(this);return e.local=Object.assign({},n),e}},{key:"get",value:function(t){for(var n=this;void 0===n.value(t)&&n.parent;)n=n.parent;return n.value(t)}},{key:"set",value:function(t,n){for(var e=this;void 0===e.value(t)&&e.parent;)e=e.parent;e.let(t,n)}},{key:"value",value:function(t){return this.local?this.local[t]:void 0}},{key:"let",value:function(t,n){this.local||(this.local={}),this.local[t]=n}}]),t}(),R="Expected a pattern, but found:",V="Expected a string, but found:",I=Object.assign,S=function(){function t(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};O(this,t),this.context=Object.assign({},n.context),this.procs=[],this.procsByName={},this.time=0,this.commands=e(this),this.onfork=n.onfork,this.onstop=n.onstop,this.onended=n.onended}return _(t,[{key:"run",value:function(t){return(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.procs.length&&(t=["@sync",t]),this.fork(null,this.context,t)}},{key:"addContext",value:function(t){return Object.assign(this.context,t),this.context}},{key:"addCommands",value:function(t){b(t)&&(t=t(this)),t&&I(this.commands,a(t))}},{key:"fork",value:function(t,n,e){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4],a=this.time+r;!i&&n&&(i=n.rate);var u=n?n.context||n:void 0,s=new M(e,u,a,i);return o(s,this.procs),t&&(this.procsByName[t]=s),this.onfork&&this.onfork({proc:s,name:t,parent:n,program:e,delay:r,rate:i}),s}},{key:"resume",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,e=this.procs;if(e.length>0){for(var r=this.time+t;--n>0&&i(e)<r;){var a=e.pop();a.resume(this.commands,r)?o(a,this.procs):this.onended&&this.onended({proc:a,time:this.time})}this.time=r}else this.time+=t;return e.length>0}},{key:"stopAll",value:function(){this.procs.length=0}},{key:"stop",value:function(t){var n=void 0;"string"==typeof n?(n=this.procsByName[t],this.procsByName[t]=null):(n=t,t=null),this.onstop&&this.onstop({name:t,proc:n}),r(n,this.procs)}}]),t}(),F=function(t){return'Instrument "'+t+'" not found.'},N=function(){function t(n,e){if(O(this,t),!n)throw Error("AudioDriver bpm is required");if(!e)throw Error("AudioDriver sampleRate is required");this.bpm=n,this.sampleRate=e,this.instruments={},this.commands=B(this)}return _(t,[{key:"addInstruments",value:function(t){return Object.assign(this.instruments,t),this.instruments}},{key:"start",value:function(t){if(this.vm)throw Error("Can't attach the same audio driver to different VM");if(t.audio)throw Error("The given VM has an audio driver already");this.vm=t,t.audio=this,t.addContext({freq:440,amp:.5}),t.addCommands(this.commands)}}]),t}(),B=function(t){return{"@play":function(n){var e=n.context,r=n.error,o=e.get("voice"),i=t.instruments[o];i?i(e):r(F(o))},"@set-bpm":function(n){var e=n.stack,r=parseFloat(e.pop(),10);r>0&&(t.bpm=r)},"@scale-tempo":function(n){var e=n.stack,r=parseFloat(e.pop(),10);r&&(t.bpm=t.bpm*r)}}},G=function(t){function n(t,e){O(this,n);var r=A(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t.context.sampleRate));return r.Gibberish=t,r}return q(n,t),_(n,[{key:"start",value:function(t){var e=this;j(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"start",this).call(this,t);var r=1/(60*this.sampleRate);this.tick=function(){return t.resume(e.bpm*r)},this.Gibberish.sequencers.push({tick:this.tick})}}]),n}(N),z=function(t,n){return function(e){t.amp=n*e.get("amp"),t.note()}},D=function(t,n){return function(e){t.amp=n*e.get("amp"),t.pitch=e.get("freq"),t.note()}},K=function(t,n){return t*n/60},H=function(t,n){return 60*t/n},L=function(t){function n(t,e){O(this,n);var r=A(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e,t.sampleRate));return r.ac=t,r.commands["@play"]=function(t){var n=t.time,e=t.context,o=t.error,i=H(n,r.bpm)+r.zero,a=e.get("voice"),u=r.instruments[a];u?u(e,i):o("@play",F(a))},r}return q(n,t),_(n,[{key:"start",value:function(t){var e=this;j(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"start",this).call(this,t);this.zero=this.ac.currentTime,p(this.ac,function(n){t.resume(K(.1,e.bpm))},.1)}}]),n}(N),W=function(t){return{kick:function(n,e){return f(t,e,100,1,.2)},snare:function(n,e){return f(t,e,476,.6,.2)},hat:function(n,e){return f(t,e,4e3,.2,.1)},conga:function(n,e){return f(t,e,4e3,.2,.1)},tom:function(n,e){return f(t,e,200,.4,.4)},pluck:function(n,e){return f(t,e,n.get("freq"),n.get("amp"),.5)},bass:function(n,e){return f(t,e,.5*n.get("freq"),n.get("amp"),.5)}}},J=function(t,n){return(t%n+n)%n},Q=function(t){return function(n){var e=n.stack;e.push(t(e.pop()))}},U=function(t){return function(n){var e=n.stack;e.push(t(e.pop(),e.pop()))}},X={"@+":U(function(t,n){return n+t}),"@add":"@+","@-":U(function(t,n){return n-t}),"@sub":"@-","@*":U(function(t,n){return n*t}),"@mul":"@*","@/":U(function(t,n){return 0===t?0:n/t}),"@div":"@/","@%":U(function(t,n){return 0===t?0:J(n,t)}),"@wrap":"@%","@mod":U(function(t,n){return 0===t?0:n%t}),"@neg":Q(function(t){return-t}),"@cond":function(t){var n=t.stack,e=t.operations,r=n.pop(),o=e.pop();r&&(e.pop(),e.push(o))},"@>":U(function(t,n){return n>t}),"@>=":U(function(t,n){return n>=t}),"@<":U(function(t,n){return n<t}),"@<=":U(function(t,n){return n<=t}),"@==":U(function(t,n){return n===t}),"@!=":U(function(t,n){return n!==t}),"@!":Q(function(t){return!t}),"@not":"@!","@&&":U(function(t,n){return n&&t}),"@and":"@&&","@||":U(function(t,n){return n||t}),"@or":"@||","@let":function(t){var n=t.stack;return t.context.let(n.pop(),n.pop())},"@set":function(t){var n=t.stack;return t.context.set(n.pop(),n.pop())},"@get":function(t){var n=t.stack,e=t.context;return n.push(e.get(n.pop()))},"@wait":function(t){return t.wait(Math.abs(Number(t.stack.pop())))},"@sync":function(t){return t.wait(Math.floor(t.time)+1-t.time)},"@scale-rate":function(t){var n=parseFloat(t.stack.pop(),10);n>0&&(t.rate*=n)},"@with-rate":function(t){var n=t.stack,e=t.operations,r=t.error,o=parseFloat(n.pop(),10),i=e.pop();k(i)||r("@with-rate",R,i),e.push([o,"@scale-rate",i,1/o,"@scale-rate"])},"@dup":function(t){var n=t.stack;return n.push(w(n))},"@execute":function(t){var n=t.operations,e=t.error,r=n.pop();y(r)?n.push("@instr"):e("@execute",V,r)},"@":"@execute","@repeat":function(t){var n=t.stack,e=t.operations,r=t.error,o=n.pop(),i=w(e);if(k(i))for(var a=1;a<o;a++)e.push(i);else r("@repeat",R,i)},"@forever":function(t){var n=t.operations,e=t.error,r=w(n);k(r)&&r.length?(n.push("@forever"),n.push(r)):e("@forever",R,r)},"@iter":function(t){var n=t.operations,e=t.error,r=n.pop();if(k(r)&&r.length){var o=r.splice(0,1);n.push(o),r.push(o)}else e("@iter",R,r)},"@rotate":function(t){var n=t.stack,e=t.operations,r=t.error,o=e.pop(),i=n.pop();if(k(o)&&o.length>0){i%=o.length;var a=o.splice(0);o.push.apply(o,a.slice(i)),o.push.apply(o,a.slice(0,i)),e.push(a)}else r("@rotate",R,o)},"@mtof":function(t){var n=t.stack,e=n.pop(),r=440*Math.pow(2,(+e-69)/12);n.push(r)},"@linear":function(t){var n=t.stack,e=n.pop(),r=n.pop(),o=n.pop(),i=n.pop(),a=n.pop();o===i?n.push(r):n.push(r+(a-i)/(o-i)*(e-r))}},Y=Math.floor,Z=function(t){return function(n){n.operations.push([t,"voice","@let","@play"])}},$=function(t,n,e){return function(r){var o=r.stack;r.operations.push(e?[o.pop(),e,"@let",o.pop(),n,"@let",t,"voice","@let","@play"]:[o.pop(),n,"@let",t,"voice","@let","@play"])}};t.initGibberish=v,t.initWebAudio=d,t.init=g,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ash-vm.js.map

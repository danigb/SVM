!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(n.AshVM=n.AshVM||{})}(this,function(n){"use strict";function t(n){return Object.keys(n).forEach(function(t){var e=n[t];v(e)&&(n[t]=n[e])}),n}function e(n){return{"@loop":function(t){var e=t.operations,r=t.error,o=e.pop();m(o)?n.fork(null,t,["@forever",o]):r("@loop",j,o)},"@fork":function(t){var e=t.operations,r=t.error,o=e.pop();m(o)?n.fork(null,t,o):r("@fork",j,o)},"@spawn":function(t){var e=t.stack,r=t.operations,o=t.error,a=e.pop(),i=r.pop();v(a)?m(i)?(n.stop(a),n.fork(a,t,["@forever",i])):o("@spawn",j,i):o("@spawn",O,a)},"@stop-all":function(t){return n.stopAll()},"@stop":function(t){var e=t.stack;return n.stop(e.pop())}}}function r(n,t){for(var e=t.length-1;e>=0&&t[e]!==n;)e--;e!==-1&&t.splice(e,1)}function o(n,t){if(0===t.length)t.push(n);else{for(var e=t.length-1,r=t[e];r&&r.time<=n.time;)e--,r=t[e];t.splice(e+1,0,n)}return n}function a(n){var t=n.length;return t?n[t-1].time:1/0}function i(n){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=s(n,t);return e.instruments=c(T(n)),e.commands=V(e),n.sequencers.push(u(e)),function(n){return e.vms.push(n),n.audio=e,e.commands}}function c(n){return Object.keys(n).forEach(function(t){var e=n[t];if(!e.prepare){var r=e.params||[];e.prepare=function(n,t){r.forEach(function(e){var r=t.get(e);k(r)&&(n[e]=r)})}}}),n}function u(n){var t=n.vms,e=n.bpm2bpa;return{tick:function(){var r=n.vms.length;if(0!==r)for(var o=n.bpm*e,a=0;a<r;a++)t[a].resume(o)}}}function s(n,t){var e=t.bpm,r=void 0===e?100:e;return n.context||n.init(),{Gibberish:n,bpm:r,sampleRate:n.context.sampleRate,bpm2bpa:1/(60*n.context.sampleRate),vms:[]}}function p(n){var t=n||Math.random,e=function(n){return K(t()*n)};return{"@random":function(n){return n.stack.push(t())},"@rand":"@random","@srandom":function(n){return n.stack.push(2*t()-1)},"@srand":"@srandom","@randi":function(n){var t=n.stack;return t.push(e(t.pop()))},"@pick":function(n){var t=n.operations,r=n.error,o=t.pop();if(m(o)){var a=e(o.length);t.push(o[a])}else t.push(o),r("Can't pick an element if is not an array",o)},"@chance":function(n){var e=n.stack,r=n.operations,o=e.pop(),a=r.pop();t()<o&&(r.pop(),r.push(a))}}}function f(n){return n=n||console.log.bind(console),{"@print":function(t){var e=t.stack;n("@print",e.length?g(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@log":function(t){var e=t.stack;n("@log",e.pop(),e.length?g(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@debug":function(t){n("@debug",t.stack,t.id,t.time)}}}function l(){return{"@pluck":_("pluck"),"@pluck-note":z("pluck","freq","amp"),"@bass":_("bass"),"@bass-note":z("bass","freq","amp"),"@hat":_("hat"),"@hat-note":z("hat","amp"),"@kick":_("kick"),"@kick-note":z("kick","amp"),"@snare":_("snare"),"@snare-note":z("snare","amp"),"@conga":_("conga"),"@conga-note":z("conga","amp"),"@clave":_("clave"),"@clave-note":z("clave","amp"),"@tom":_("tom"),"@tom-note":z("tom","amp")}}function h(n){var t=new P({amp:.5,freq:440});t.addCommands(i(n)),t.addCommands(p()),t.addCommands(f()),t.addCommands(l());for(var e=arguments.length,r=Array(e>1?e-1:0),o=1;o<e;o++)r[o-1]=arguments[o];return r.forEach(function(n){return t.addCommands(n)}),t}var m=Array.isArray,v=function(n){return"string"==typeof n},d=function(n){return"function"==typeof n},k=function(n){return void 0!==n},y=function(n){return n[n.length-1]},g=y,b=function(n,t){return(n%t+t)%t},w=function(n,t){if(!(n instanceof t))throw new TypeError("Cannot call a class as a function")},x=function(){function n(n,t){for(var e=0;e<t.length;e++){var r=t[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),C=function(n){return"string"==typeof n&&"@"===n[0]},q=Array.isArray,E=1,M=function(){function n(t,e,r,o){w(this,n),this.id="proc-"+E++,this.stack=[],this.operations=t?[t]:[],this.context=new A(e),this.time="number"==typeof r?r:0,this.rate="number"==typeof o?o:1,this.error=this.error.bind(this)}return x(n,[{key:"wait",value:function(n){this.time+=this.rate*n}},{key:"step",value:function(n){var t=this.operations;if(t.length){var e=t.pop();if(null===e||void 0===e);else if("function"==typeof instruction)e();else if(q(e))for(var r=e.length-1;r>=0;r--)t.push(e[r]);else if(C(e)){var o=n[e];"function"==typeof o?o(this):this.error("","Instruction not recognized.",e)}else this.stack.push(e)}}},{key:"resume",value:function(n){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,r=this.operations;--e>0&&this.time<t&&r.length;)this.step(n);if(0===e)throw Error("Limit reached. Probably an infinity loop.");return r.length>0}},{key:"error",value:function(n,t,e){console.error(n,t,e,"id",this.id,"time",this.time)}}]),n}(),A=function(){function n(t){w(this,n),t instanceof n?this.parent=t:t&&(this.local=Object.assign({},t))}return x(n,[{key:"child",value:function(t){var e=new n(this);return e.local=Object.assign({},t),e}},{key:"get",value:function(n){for(var t=this;void 0===t.value(n)&&t.parent;)t=t.parent;return t.value(n)}},{key:"set",value:function(n,t){for(var e=this;void 0===e.value(n)&&e.parent;)e=e.parent;e.let(n,t)}},{key:"value",value:function(n){return this.local?this.local[n]:void 0}},{key:"let",value:function(n,t){this.local||(this.local={}),this.local[n]=t}}]),n}(),j="Expected a pattern, but found:",O="Expected a string, but found:",N=function(n){return function(t){var e=t.stack;e.push(n(e.pop()))}},S=function(n){return function(t){var e=t.stack;e.push(n(e.pop(),e.pop()))}},B={"@+":S(function(n,t){return t+n}),"@add":"@+","@-":S(function(n,t){return t-n}),"@sub":"@-","@*":S(function(n,t){return t*n}),"@mul":"@*","@/":S(function(n,t){return 0===n?0:t/n}),"@div":"@/","@%":S(function(n,t){return 0===n?0:b(t,n)}),"@wrap":"@%","@mod":S(function(n,t){return 0===n?0:t%n}),"@neg":N(function(n){return-n}),"@cond":function(n){var t=n.stack,e=n.operations,r=t.pop(),o=e.pop();r&&(e.pop(),e.push(o))},"@>":S(function(n,t){return t>n}),"@>=":S(function(n,t){return t>=n}),"@<":S(function(n,t){return t<n}),"@<=":S(function(n,t){return t<=n}),"@==":S(function(n,t){return t===n}),"@!=":S(function(n,t){return t!==n}),"@!":N(function(n){return!n}),"@not":"@!","@&&":S(function(n,t){return t&&n}),"@and":"@&&","@||":S(function(n,t){return t||n}),"@or":"@||","@let":function(n){var t=n.stack;return n.context.let(t.pop(),t.pop())},"@set":function(n){var t=n.stack;return n.context.set(t.pop(),t.pop())},"@get":function(n){var t=n.stack,e=n.context;return t.push(e.get(t.pop()))},"@wait":function(n){return n.wait(Math.abs(Number(n.stack.pop())))},"@sync":function(n){return n.wait(Math.floor(n.time)+1-n.time)},"@scale-rate":function(n){var t=parseFloat(n.stack.pop(),10);t>0&&(n.rate*=t)},"@with-rate":function(n){var t=n.stack,e=n.operations,r=n.error,o=parseFloat(t.pop(),10),a=e.pop();m(a)||r("@with-rate",j,a),e.push([o,"@scale-rate",a,1/o,"@scale-rate"])},"@dup":function(n){var t=n.stack;return t.push(y(t))},"@execute":function(n){var t=n.operations,e=n.error,r=t.pop();v(r)?t.push("@instr"):e("@execute",O,r)},"@":"@execute","@repeat":function(n){var t=n.stack,e=n.operations,r=t.pop(),o=y(e);if(!m(o))throw Error("Can't repeat: "+o);for(var a=1;a<r;a++)e.push(o)},"@forever":function(n){var t=n.operations,e=y(t);if(!m(e))throw Error("Can't forover: "+e);e.length&&(t.push("@forever"),t.push(e))},"@iter":function(n){var t=n.operations,e=n.error,r=t.pop();if(m(r)&&r.length){var o=r.splice(0,1);t.push(o),r.push(o)}else e("@iter",j,r)},"@reverse":function(n){n.operations}},F=Object.assign,P=function(){function n(t){w(this,n),this.context=t,this.procs=[],this.procsByName={},this.time=0,this.commands=e(this),this.addCommands(B)}return x(n,[{key:"run",value:function(n){return(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.procs.length&&(n=["@sync",n]),this.fork(null,this.context,n)}},{key:"addCommands",value:function(n){d(n)&&(n=n(this)),n&&F(this.commands,t(n))}},{key:"fork",value:function(n,t,e){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,a=arguments[4],i=this.time+r;!a&&t&&(a=t.rate);var c=t?t.context||t:void 0,u=new M(e,c,i,a);return o(u,this.procs),n&&(this.procsByName[n]=u),u}},{key:"resume",value:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,e=this.procs;if(0===e.length)return!1;for(var r=this.time+n;--t>0&&a(e)<r;){var i=e.pop();i.resume(this.commands,r)&&o(i,this.procs)}return this.time=r,e.length>0}},{key:"stopAll",value:function(){this.procs.length=0}},{key:"stop",value:function(n){if("string"==typeof n){var t=n;n=this.procsByName[t],this.procsByName[t]=null}r(n,this.procs)}}]),n}(),R=function(n){return'Instrument "'+n+'" not found.'},T=function(n){return{kick:{params:["amp","pitch","decay","tone"],init:function(){return new n.Kick({decay:.2}).connect()}},snare:{params:["amp","tune","cutoff","snappy"],init:function(){return new n.Snare({snappy:1.5}).connect()}},hat:{params:["amp","pitch"],init:function(){return new n.Hat({amp:1.5}).connect()}},conga:{params:["amp","pitch"],init:function(){return new n.Conga({amp:.25,freq:400}).connect()}},clave:{params:["amp","pitch"],init:function(){return new n.Clave({amp:1}).connect()}},tom:{params:["amp","pitch"],init:function(){return new n.Tom({amp:.25,freq:400}).connect()}},clap:{params:["amp"],init:function(){return new n.Clap({amp:.5}).connect()}},cowbell:{params:["amp","pitch"],init:function(){return new n.Cowbell({amp:.5}).connect()}},pluck:{params:["freq","amp","blend","damping","velocity"],init:function(){return new n.PolyKarplusStrong({maxVoices:32}).connect()},prepare:function(t,e){var r=e.get("freq");r>0&&(t.freq=r,t.damping=1- -6/Math.log(r/n.sampleRate));var o=e.get("amp");o&&(t.amp=o*o*.5);var a=e.get("blend");a&&(t.blend=a)}},bass:{params:["freq","amp","resonance"],init:function(){return new n.MonoSynth({attack:44,decay:n.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}},V=function(n){return{"@play":function(t){var e=t.context,r=t.error,o=I(e,n);o&&r("@play",o)},"@play-note":function(t){var e=t.stack,r=t.context,o=t.error,a=e.pop(),i=I(r.child(a),n);i&&o("@play-note",i)},"@set-bpm":function(t){var e=t.stack,r=parseFloat(e.pop(),10);r>0&&(n.bpm=r)},"@scale-tempo":function(t){var e=t.stack,r=parseFloat(e.pop(),10);r&&(n.bpm*=r)}}},I=function(n,t){var e=t.instruments,r=n.get("inst"),o=e[r];if(!o)return R(r);o.instance||(o.instance=o.init());var a=o.instance;o.prepare(a,n),a.freq?a.note(a.freq):a.note()},K=Math.floor,_=function(n){return function(t){t.operations.push([{inst:n},"@play-note"])}},z=function(n,t,e){return function(r){var o=r.stack,a=r.operations,i={inst:n};e&&(i[e]=o.pop()),i[t]=o.pop(),a.push([i,"@play-note"])}};n.init=h,Object.defineProperty(n,"__esModule",{value:!0})});
//# sourceMappingURL=ash-vm.js.map

!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n(t.AshVM=t.AshVM||{})}(this,function(t){"use strict";function n(t,n){setTimeout(function(){t(n)},0)}function e(t){return Object.keys(t).forEach(function(n){var e=t[n];w(e)&&(t[n]=t[e])}),t}function r(t){return{"@loop":function(n){var e=n.operations,r=n.error,o=e.pop();b(o)?t.fork(null,n,["@forever",o]):r("@loop",N,o)},"@fork":function(n){var e=n.operations,r=n.error,o=e.pop();b(o)?t.fork(null,n,o):r("@fork",N,o)},"@spawn":function(n){var e=n.stack,r=n.operations,o=n.error,i=e.pop(),a=r.pop();w(i)?b(a)?(t.stop(i),t.fork(i,n,["@forever",a])):o("@spawn",N,a):o("@spawn",S,i)},"@stop-all":function(n){return t.stopAll()},"@stop":function(n){var e=n.stack;return t.stop(e.pop())}}}function o(t,n){for(var e=n.length-1;e>=0&&n[e]!==t;)e--;return e!==-1&&n.splice(e,1),e!==-1}function i(t,n){if(0===n.length)n.push(t);else{for(var e=n.length-1,r=n[e];r&&r.time<=t.time;)e--,r=n[e];n.splice(e+1,0,t)}return t}function a(t){var n=t.length;return n?t[n-1].time:1/0}function u(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=p(t,n);return e.instruments=c(z(t)),e.commands=H(e),t.sequencers.push(s(e)),function(t){return e.vms.push(t),t.audio=e,e.commands}}function c(t){return Object.keys(t).forEach(function(n){var e=t[n];if(!e.prepare){var r=e.params||[];e.prepare=function(t,n){r.forEach(function(e){var r=n.get(e);q(r)&&(t[e]=r)})}}}),t}function s(t){var n=t.vms,e=t.bpm2bpa;return{tick:function(){var r=t.vms.length,o=t.bpm*e;if(1===r)n[0].resume(o);else if(r>1)for(var i=0;i<r;i++)n[i].resume(o)}}}function p(t,n){var e=n.bpm,r=void 0===e?100:e;return t.context||t.init(),{Gibberish:t,bpm:r,sampleRate:t.context.sampleRate,bpm2bpa:1/(60*t.context.sampleRate),vms:[]}}function f(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.context||new AudioContext,e={paused:!1,bpm:t.bpm||120,instruments:{pluck:function(t,e){return h(n,t,e.get("freq"),e.get("amp"),.5)},hat:function(t,e){return h(n,t,4e3,.2,.1)},kick:function(t,e){return h(n,t,100,1,.2)},snare:function(t,e){return h(n,t,476,.6,.2)},tom:function(t,e){return h(n,t,200,.4,.4)}}};e.stop=function(){return clearInterval(e.seq)};var r=W(.1,e.bpm);return function(t){var o=n.currentTime;return l(n,function(n){t.resume(r)},.1),t.audio=e,{"@play":function(t){var n=t.time,r=t.context,i=t.error,a=D(n,e.bpm)+o,u=r.get("inst"),c=e.instruments[u];c?c(a,r):i("@play",J,u)}}}}function l(t,n,e){var r=e||.1,o=r/3,i=t.currentTime+r,a=function(){t.currentTime+r>=i&&(n(i),i+=r)};return a(),setInterval(a,o)}function h(t,n,e,r,o){var i=t.createOscillator();return i.frequency.value=e||200,i.amp=t.createGain(),i.amp.gain.value=0,i.connect(i.amp),i.amp.connect(t.destination),i.start(n),i.amp.gain.setValueAtTime(0,n),i.amp.gain.linearRampToValueAtTime(.5*r,n+.01),i.amp.gain.linearRampToValueAtTime(0,n+o),i.stop(n+o+.1),i}function m(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.random,e=n||Math.random,r=function(t){return Q(e()*t)},o=function(t){var e,r,o;for(o=t.length;o;o--)e=Q(n()*o),r=t[o-1],t[o-1]=t[e],t[e]=r};return{"@random":function(t){return t.stack.push(e())},"@rand":"@random","@srandom":function(t){return t.stack.push(2*e()-1)},"@srand":"@srandom","@randi":function(t){var n=t.stack;return n.push(r(n.pop()))},"@pick":function(t){var n=t.operations,e=t.error,o=n.pop();if(b(o)){var i=r(o.length);n.push(o[i])}else n.push(o),e("Can't pick an element if is not an array",o)},"@chance":function(t){var n=t.stack,r=t.operations,o=n.pop(),i=r.pop();e()<o&&(r.pop(),r.push(i))},"@shuffle":function(t){var n=(t.stack,t.operations),e=t.error,r=n.pop();b(r)?n.push(o(r)):e("@shuffle",N,r)}}}function v(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.log;return n=n||console.log.bind(console),{"@print":function(t){var e=t.stack;n("@print",e.length?A(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@log":function(t){var e=t.stack;n("@log",e.pop(),e.length?A(e):"<Empty Stack>","(id, time)",t.id,t.time)},"@debug":function(t){n("@debug",t.stack,t.id,t.time)}}}function d(){return{"@set-freq":function(t){var n=t.context,e=t.stack;return n.set("freq",e.pop())},"@set-amp":function(t){var n=t.context,e=t.stack;return n.set("amp",e.pop())},"@get-freq":function(t){var n=t.stack,e=t.context;return n.push(e.get("freq"))},"@get-amp":function(t){var n=t.stack,e=t.context;return n.push(e.get("amp"))},"@reverse":function(t){var n=t.operations,e=t.error,r=n.pop();b(r)?n.push(r.slice().reverse()):e("@reverse",N,r)},"@map":"@linear","@pluck":U("pluck"),"@pluck-note":X("pluck","freq","amp"),"@bass":U("bass"),"@bass-note":X("bass","freq","amp"),"@hat":U("hat"),"@hat-note":X("hat","amp"),"@kick":U("kick"),"@kick-note":X("kick","amp"),"@snare":U("snare"),"@snare-note":X("snare","amp"),"@conga":U("conga"),"@conga-note":X("conga","amp"),"@clave":U("clave"),"@clave-note":X("clave","amp"),"@tom":U("tom"),"@tom-note":X("tom","amp")}}function k(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return y(u(t,n),n)}function g(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return y(f(t,n),n)}function y(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},e=n.plugins,r=new K({amp:.5,freq:440},n);return r.addCommands(t),r.addCommands(m(n)),r.addCommands(v(n)),r.addCommands(d(n)),e&&e.forEach(function(t){return r.addCommands(t)}),r}var b=Array.isArray,w=function(t){return"string"==typeof t},x=function(t){return"function"==typeof t},q=function(t){return void 0!==t},C=function(t){return t[t.length-1]},A=C,T=function(t,n){return(t%n+n)%n},M=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},E=function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}(),j=function(t){return"string"==typeof t&&"@"===t[0]},O=Array.isArray,R=1,V=function(){function t(n,e,r,o){M(this,t),this.id="proc-"+R++,this.stack=[],this.operations=n?[n]:[],this.context=new I(e),this.time="number"==typeof r?r:0,this.rate="number"==typeof o?o:1,this.error=this.error.bind(this)}return E(t,[{key:"wait",value:function(t){this.time+=this.rate*t}},{key:"step",value:function(t){var e=this.operations;if(e.length){var r=e.pop();if(null===r||void 0===r);else if("function"==typeof r)n(r,this.time);else if(O(r))for(var o=r.length-1;o>=0;o--)e.push(r[o]);else if(j(r)){var i=t[r];"function"==typeof i?i(this):this.error("step > ","Instruction not recognized.",r)}else this.stack.push(r)}}},{key:"resume",value:function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,r=this.operations;--e>0&&this.time<n&&r.length;)this.step(t);if(0===e)throw Error("Limit reached. Probably an infinity loop.");return r.length>0}},{key:"error",value:function(t,n,e){console.error(t,n,e,"id",this.id,"time",this.time)}}]),t}(),I=function(){function t(n){M(this,t),n instanceof t?this.parent=n:n&&(this.local=Object.assign({},n))}return E(t,[{key:"child",value:function(n){var e=new t(this);return e.local=Object.assign({},n),e}},{key:"get",value:function(t){for(var n=this;void 0===n.value(t)&&n.parent;)n=n.parent;return n.value(t)}},{key:"set",value:function(t,n){for(var e=this;void 0===e.value(t)&&e.parent;)e=e.parent;e.let(t,n)}},{key:"value",value:function(t){return this.local?this.local[t]:void 0}},{key:"let",value:function(t,n){this.local||(this.local={}),this.local[t]=n}}]),t}(),N="Expected a pattern, but found:",S="Expected a string, but found:",B=function(t){return function(n){var e=n.stack;e.push(t(e.pop()))}},F=function(t){return function(n){var e=n.stack;e.push(t(e.pop(),e.pop()))}},P={"@+":F(function(t,n){return n+t}),"@add":"@+","@-":F(function(t,n){return n-t}),"@sub":"@-","@*":F(function(t,n){return n*t}),"@mul":"@*","@/":F(function(t,n){return 0===t?0:n/t}),"@div":"@/","@%":F(function(t,n){return 0===t?0:T(n,t)}),"@wrap":"@%","@mod":F(function(t,n){return 0===t?0:n%t}),"@neg":B(function(t){return-t}),"@cond":function(t){var n=t.stack,e=t.operations,r=n.pop(),o=e.pop();r&&(e.pop(),e.push(o))},"@>":F(function(t,n){return n>t}),"@>=":F(function(t,n){return n>=t}),"@<":F(function(t,n){return n<t}),"@<=":F(function(t,n){return n<=t}),"@==":F(function(t,n){return n===t}),"@!=":F(function(t,n){return n!==t}),"@!":B(function(t){return!t}),"@not":"@!","@&&":F(function(t,n){return n&&t}),"@and":"@&&","@||":F(function(t,n){return n||t}),"@or":"@||","@let":function(t){var n=t.stack;return t.context.let(n.pop(),n.pop())},"@set":function(t){var n=t.stack;return t.context.set(n.pop(),n.pop())},"@get":function(t){var n=t.stack,e=t.context;return n.push(e.get(n.pop()))},"@wait":function(t){return t.wait(Math.abs(Number(t.stack.pop())))},"@sync":function(t){return t.wait(Math.floor(t.time)+1-t.time)},"@scale-rate":function(t){var n=parseFloat(t.stack.pop(),10);n>0&&(t.rate*=n)},"@with-rate":function(t){var n=t.stack,e=t.operations,r=t.error,o=parseFloat(n.pop(),10),i=e.pop();b(i)||r("@with-rate",N,i),e.push([o,"@scale-rate",i,1/o,"@scale-rate"])},"@dup":function(t){var n=t.stack;return n.push(C(n))},"@execute":function(t){var n=t.operations,e=t.error,r=n.pop();w(r)?n.push("@instr"):e("@execute",S,r)},"@":"@execute","@repeat":function(t){var n=t.stack,e=t.operations,r=t.error,o=n.pop(),i=C(e);if(b(i))for(var a=1;a<o;a++)e.push(i);else r("@repeat",N,i)},"@forever":function(t){var n=t.operations,e=t.error,r=C(n);b(r)&&r.length?(n.push("@forever"),n.push(r)):e("@forever",N,r)},"@iter":function(t){var n=t.operations,e=t.error,r=n.pop();if(b(r)&&r.length){var o=r.splice(0,1);n.push(o),r.push(o)}else e("@iter",N,r)},"@rotate":function(t){var n=t.stack,e=t.operations,r=t.error,o=e.pop(),i=n.pop();if(b(o)&&o.length>0){i%=o.length;var a=o.splice(0);o.push.apply(o,a.slice(i)),o.push.apply(o,a.slice(0,i)),e.push(a)}else r("@rotate",N,o)},"@mtof":function(t){var n=t.stack,e=n.pop(),r=440*Math.pow(2,(+e-69)/12);n.push(r)},"@linear":function(t){var n=t.stack,e=n.pop(),r=n.pop(),o=n.pop(),i=n.pop(),a=n.pop();o===i?n.push(r):n.push(r+(a-i)/(o-i)*(e-r))}},G=Object.assign,K=function(){function t(n){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};M(this,t),this.context=n,this.procs=[],this.procsByName={},this.time=0,this.commands=r(this),this.addCommands(P),this.onfork=e.onfork,this.onstop=e.onstop,this.onended=e.onended}return E(t,[{key:"run",value:function(t){return(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.procs.length&&(t=["@sync",t]),this.fork(null,this.context,t)}},{key:"addCommands",value:function(t){x(t)&&(t=t(this)),t&&G(this.commands,e(t))}},{key:"fork",value:function(t,n,e){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments[4],a=this.time+r;!o&&n&&(o=n.rate);var u=n?n.context||n:void 0,c=new V(e,u,a,o);return i(c,this.procs),t&&(this.procsByName[t]=c),this.onfork&&this.onfork({proc:c,name:t,parent:n,program:e,delay:r,rate:o}),c}},{key:"resume",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,e=this.procs;if(e.length>0){for(var r=this.time+t;--n>0&&a(e)<r;){var o=e.pop();o.resume(this.commands,r)?i(o,this.procs):this.onended&&this.onended({proc:o,time:this.time})}this.time=r}else this.time+=t;return e.length>0}},{key:"stopAll",value:function(){this.procs.length=0}},{key:"stop",value:function(t){var n=void 0;"string"==typeof n?(n=this.procsByName[t],this.procsByName[t]=null):(n=t,t=null),this.onstop&&this.onstop({name:t,proc:n}),o(n,this.procs)}}]),t}(),_=function(t){return'Instrument "'+t+'" not found.'},z=function(t){return{kick:{params:["amp","pitch","decay","tone"],init:function(){return new t.Kick({decay:.2}).connect()}},snare:{params:["amp","tune","cutoff","snappy"],init:function(){return new t.Snare({snappy:1.5}).connect()}},hat:{params:["amp","pitch"],init:function(){return new t.Hat({amp:1.5}).connect()}},conga:{params:["amp","pitch"],init:function(){return new t.Conga({amp:.25,freq:400}).connect()}},clave:{params:["amp","pitch"],init:function(){return new t.Clave({amp:1}).connect()}},tom:{params:["amp","pitch"],init:function(){return new t.Tom({amp:.25,freq:400}).connect()}},clap:{params:["amp"],init:function(){return new t.Clap({amp:.5}).connect()}},cowbell:{params:["amp","pitch"],init:function(){return new t.Cowbell({amp:.5}).connect()}},pluck:{params:["freq","amp","blend","damping","velocity"],init:function(){return new t.PolyKarplusStrong({maxVoices:32}).connect()},prepare:function(n,e){var r=e.get("freq");r>0&&(n.freq=r,n.damping=1- -6/Math.log(r/t.sampleRate));var o=e.get("amp");o&&(n.amp=o*o*.5);var i=e.get("blend");i&&(n.blend=i)}},bass:{params:["freq","amp","resonance"],init:function(){return new t.MonoSynth({attack:44,decay:t.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect()}}}},H=function(t){return{"@play":function(n){var e=n.context,r=n.error,o=L(e,t);o&&r("@play",o)},"@play-note":function(n){var e=n.stack,r=n.context,o=n.error,i=e.pop(),a=L(r.child(i),t);a&&o("@play-note",a)},"@set-bpm":function(n){var e=n.stack,r=parseFloat(e.pop(),10);r>0&&(t.bpm=r)},"@scale-tempo":function(n){var e=n.stack,r=parseFloat(e.pop(),10);r&&(t.bpm*=r)}}},L=function(t,n){var e=n.instruments,r=t.get("inst"),o=e[r];if(!o)return _(r);o.instance||(o.instance=o.init());var i=o.instance;o.prepare(i,t),i.freq?i.note(i.freq):i.note()},W=function(t,n){return t*n/60},D=function(t,n){return 60*t/n},J="Instrument not found: ",Q=Math.floor,U=function(t){return function(n){n.operations.push([t,"inst","@let","@play"])}},X=function(t,n,e){return function(r){var o=r.stack;r.operations.push(e?[o.pop(),e,"@let",o.pop(),n,"@let",t,"inst","@let","@play"]:[o.pop(),n,"@let",t,"inst","@let","@play"])}};t.initGibberish=k,t.initWebAudio=g,t.init=y,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ash-vm.js.map

!function(t){"use strict";function n(t){return Object.keys(t).forEach(function(n){var r=t[n];d(r)&&(t[n]=t[r])}),t}function r(t){return{"@loop":function(n){var r=n.instructions,e=n.error,o=r.pop();m(o)?t.fork(null,n,["@forever",o]):e("@loop",S,o)},"@fork":function(n){var r=n.instructions,e=n.error,o=r.pop();m(o)?t.fork(null,n,o):e("@fork",S,o)},"@spawn":function(n){var r=n.stack,e=n.instructions,o=n.error,i=r.pop(),u=e.pop();d(i)?m(u)?(t.stop(i),t.fork(i,n,["@forever",u])):o("@spawn",S,u):o("@spawn",j,i)},"@stop-all":function(n){return t.stopAll()},"@stop":function(n){var r=n.stack;return t.stop(r.pop())}}}function e(t,n){for(var r=n.length-1;r>=0&&n[r]!==t;)r--;r!==-1&&n.splice(r,1)}function o(t,n){if(0===n.length)n.push(t);else{for(var r=n.length-1,e=n[r];e&&e.time<=t.time;)r--,e=n[r];n.splice(r+1,0,t)}return t}function i(t){var n=t.length;return n?t[n-1].time:1/0}function u(t,n){return 1===arguments.length?function(n){return u(t,n)}:(null===T&&a(),I.push(n),n.addCommands(R),t)}function a(){Gibberish.init(),T=Gibberish.context.sampleRate,V=1/(60*T),K=s(Gibberish,H),R=c(K,Q),Gibberish.sequencers.push(z)}function s(t,n){return n.reduce(function(n,r){var e=x(r,3),o=e[0],i=e[1],u=e[2];return n[o]=new t[i](u).connect(),n},{})}function c(t,n){return Object.keys(n).reduce(function(r,e){var o=n[e],i=t[e];return r["@"+e]=f(i,o),r["@"+e+"-note"]=p(i,o),r},{})}function f(t,n){var r=x(n,3),e=r[0],o=r[1],i=r[2];return function(n){var r=n.context;return i(t,r.get(e),r.get(o))}}function p(t,n){var r=x(n,3),e=(r[0],r[1]),o=r[2];return function(n){var r=n.stack;return o(t,r.pop(),e?r.pop():void 0)}}function l(t){var n=t||Math.random,r=function(t){return U(n()*t)};return{"@random":function(t){return t.stack.push(n())},"@rand":"@random","@srandom":function(t){return t.stack.push(2*n()-1)},"@srand":"@srandom","@randi":function(t){var n=t.stack;return n.push(r(n.pop()))},"@pick":function(t){var n=t.instructions,e=t.error,o=n.pop();if(m(o)){var i=r(o.length);n.push(o[i])}else n.push(o),e("Can't pick an element if is not an array",o)},"@chance":function(t){var r=t.stack,e=t.instructions,o=r.pop(),i=e.pop();n()<o&&(e.pop(),e.push(i))}}}function h(t){return t=t||console.log.bind(console),{"@print":function(n){var r=n.stack;t("@print",r.length?y(r):"<Empty Stack>","(id, time)",n.id,n.time)},"@log":function(n){var r=n.stack;t("@log",r.pop(),r.length?y(r):"<Empty Stack>","(id, time)",n.id,n.time)},"@debug":function(n){t("@debug",n.stack,n.id,n.time)}}}function v(t){var n=new P({amp:.5,freq:440});n.addCommands(l()),n.addCommands(h());for(var r=arguments.length,e=Array(r>1?r-1:0),o=1;o<r;o++)e[o-1]=arguments[o];return e.forEach(function(t){return n.addCommands(t)}),u(t,n),n}var m=Array.isArray,d=function(t){return"string"==typeof t},k=function(t){return t[t.length-1]},y=k,g=function(t,n){return(t%n+n)%n},b=function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")},w=function(){function t(t,n){for(var r=0;r<n.length;r++){var e=n[r];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}return function(n,r,e){return r&&t(n.prototype,r),e&&t(n,e),n}}(),x=function(){function t(t,n){var r=[],e=!0,o=!1,i=void 0;try{for(var u,a=t[Symbol.iterator]();!(e=(u=a.next()).done)&&(r.push(u.value),!n||r.length!==n);e=!0);}catch(t){o=!0,i=t}finally{try{!e&&a.return&&a.return()}finally{if(o)throw i}}return r}return function(n,r){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),A=function(t){return"string"==typeof t&&"@"===t[0]},C=Array.isArray,E=1,q=function(){function t(n,r,e,o){b(this,t),this.id="proc-"+E++,this.stack=[],this.instructions=n?[n]:[],this.context=new M(r),this.time="number"==typeof e?e:0,this.rate="number"==typeof o?o:1,this.error=this.error.bind(this)}return w(t,[{key:"wait",value:function(t){this.time+=this.rate*t}},{key:"step",value:function(t){var n=this.instructions;if(n.length){var r=n.pop();if(null===r||void 0===r);else if("function"==typeof instruction)r();else if(C(r))for(var e=r.length-1;e>=0;e--)n.push(r[e]);else if(A(r)){var o=t[r];"function"==typeof o?o(this):this.error("","Instruction not recognized.",r)}else this.stack.push(r)}}},{key:"resume",value:function(t){for(var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4,e=this.instructions;--r>0&&this.time<n&&e.length;)this.step(t);return 0===r&&this.error("Resume","Limit reached. Probably an infinity loop."),e.length>0}},{key:"error",value:function(t,n,r){console.error(t,n,r,"id",this.id,"time",this.time)}}]),t}(),M=function(){function t(n){b(this,t),n instanceof t?this.parent=n:n&&(this.local=Object.assign({},n))}return w(t,[{key:"get",value:function(t){for(var n=this;void 0===n.value(t)&&n.parent;)n=n.parent;return n.value(t)}},{key:"set",value:function(t,n){for(var r=this;void 0===r.value(t)&&r.parent;)r=r.parent;r.let(t,n)}},{key:"value",value:function(t){return this.local?this.local[t]:void 0}},{key:"let",value:function(t,n){this.local||(this.local={}),this.local[t]=n}}]),t}(),S="Expected a pattern, but found:",j="Expected a string, but found:",O=function(t){return function(n){var r=n.stack;r.push(t(r.pop()))}},N=function(t){return function(n){var r=n.stack;r.push(t(r.pop(),r.pop()))}},B={"@+":N(function(t,n){return n+t}),"@add":"@+","@-":N(function(t,n){return n-t}),"@sub":"@-","@*":N(function(t,n){return n*t}),"@mul":"@*","@/":N(function(t,n){return 0===t?0:n/t}),"@div":"@/","@%":N(function(t,n){return 0===t?0:g(n,t)}),"@wrap":"@%","@mod":N(function(t,n){return 0===t?0:n%t}),"@neg":O(function(t){return-t}),"@cond":function(t){var n=t.stack,r=t.instructions,e=n.pop(),o=r.pop();e&&(r.pop(),r.push(o))},"@>":N(function(t,n){return n>t}),"@>=":N(function(t,n){return n>=t}),"@<":N(function(t,n){return n<t}),"@<=":N(function(t,n){return n<=t}),"@==":N(function(t,n){return n===t}),"@!=":N(function(t,n){return n!==t}),"@!":O(function(t){return!t}),"@not":"@!","@&&":N(function(t,n){return n&&t}),"@and":"@&&","@||":N(function(t,n){return n||t}),"@or":"@||","@let":function(t){var n=t.stack;return t.context.let(n.pop(),n.pop())},"@set":function(t){var n=t.stack;return t.context.set(n.pop(),n.pop())},"@get":function(t){var n=t.stack,r=t.context;return n.push(r.get(n.pop()))},"@wait":function(t){return t.wait(Math.abs(Number(t.stack.pop())))},"@sync":function(t){return t.wait(Math.floor(t.time)+1-t.time)},"@dup":function(t){var n=t.stack;return n.push(k(n))},"@execute":function(t){var n=t.instructions,r=t.error,e=n.pop();d(e)?n.push("@instr"):r("@execute",j,e)},"@":"@execute","@repeat":function(t){var n=t.stack,r=t.instructions,e=n.pop(),o=k(r);if(!m(o))throw Error("Can't repeat: "+o);for(var i=1;i<e;i++)r.push(o)},"@forever":function(t){var n=t.instructions,r=k(n);if(!m(r))throw Error("Can't forover: "+r);r.length&&(n.push("@forever"),n.push(r))},"@iter":function(t){var n=t.instructions,r=t.error,e=n.pop();if(m(e)&&e.length){var o=e.splice(0,1);n.push(o),e.push(o)}else r("@iter",S,e)}},G=Object.assign,P=function(){function t(n){b(this,t),this.context=n,this.procs=[],this.procsByName={},this.time=0,this.commands=r(this),this.addCommands(B)}return w(t,[{key:"run",value:function(t){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.procs.length&&(t=["@sync",t]),this.fork(null,this.context,t)}},{key:"addCommands",value:function(t){G(this.commands,n(t))}},{key:"fork",value:function(t,n,r){var e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments[4],u=this.time+e;!i&&n&&(i=n.rate);var a=n?n.context||n:void 0,s=new q(r,a,u,i);return o(s,this.procs),t&&(this.procsByName[t]=s),s}},{key:"resume",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1/0,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4,r=this.procs;if(0===r.length)return!1;for(var e=this.time+t;--n>0&&i(r)<e;){var u=r.pop();u.resume(this.commands,e)&&o(u,this.procs)}return this.time=e,r.length>0}},{key:"stopAll",value:function(){this.procs.length=0}},{key:"stop",value:function(t){if("string"==typeof t){var n=t;t=this.procsByName[n],this.procsByName[n]=null}e(t,this.procs)}}]),t}(),T=null,V=null,I=[],K=null,R=null,z={tick:function(){var t=I.length;if(0!==t)for(var n=100*V,r=0;r<t;r++)I[r].resume(n)}},H=[["kick","Kick",{decay:.2}],["snare","Snare",{snappy:1.5}],["hat","Hat",{amp:1.5}],["conga","Conga",{amp:.25,freq:400}],["tom","Tom",{amp:.25,freq:400}],["pluck","PolyKarplusStrong",{maxVoices:32}],["bass","MonoSynth",{attack:44,decay:.25,filterMult:.25,octave2:0,octave3:0}]],L=function(t,n){t.amp=n,t.note()},D=function(t,n,r){t.amp=n,t.freq=r,t.note()},F=function(t,n,r){r>0&&t.note(n,r)},J=function(t,n,r){r>0&&(t.damping=1- -6/Math.log(r/T),t.note(r,n*n*2))},Q={pluck:["amp","freq",J],bass:["amp","freq",F],kick:["amp",null,L],snare:["amp",null,L],hat:["amp",null,L],conga:["amp","freq",D],tom:["amp","freq",D]},U=Math.floor;t.init=v}(this.AshVM=this.AshVM||{});
//# sourceMappingURL=ash-vm.js.map

var ScheddVM=function(){"use strict";function t(t,s){this.t=h.t,this.heap=[],this.name=s||"default",this.context={freq:440,amp:1},t&&this.fork(t,this.t,this);var e=f[this.name];void 0!==e&&e.disconnect(),f[this.name]=this}function s(t,s,e,r){this.t=s||0,this.pq=e,this.rate=1,this.todo=[],this.stack=[],this.parentQ=r,this.context=r?{}:{freq:440,amp:1},this.debug=!1,t&&this.push(t)}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};console.log("ScheddVM init",Gibberish,MIDI);var r=function(){var t=0;return function(){return"uid"+ ++t}}();MIDI.init(),Gibberish.init(),Gibberish.Time.export(),Gibberish.Binops.export();var a=100,o=Gibberish.context.sampleRate,i=1/(60*o),h={linked:!1,t:0},p=new Gibberish.Kick({decay:.2}).connect(),n=new Gibberish.Snare({snappy:1.5}).connect(),c=new Gibberish.Hat({amp:1.5}).connect(),u=new Gibberish.Conga({amp:.25,freq:400}).connect(),k=new Gibberish.Tom({amp:.25,freq:400}).connect(),b=new Gibberish.PolyKarplusStrong({maxVoices:32}).connect(),d=new Gibberish.MonoSynth({attack:44,decay:Gibberish.Time.beats(.25),filterMult:.25,octave2:0,octave3:0}).connect(),l={},f={},v={};l.seq={},l.sequencers={},l.spawns={};var m={t:0,beat:-1,cmds:[]};m.tick=function(t){h.linked||this.resume(this.t+a*i)},m.resume=function(t){var s=Math.floor(t);if(s>this.beat)for(this.beat=s;this.cmds.length;){var e=this.cmds.shift();e()}return this.t=t,this},Gibberish.sequencers.push(m),l.seq.clear=function(){for(var t in f)f[t].disconnect(),delete f[t];v={},MIDI&&MIDI.send([123,0],0)},l.seq.play_element_value=function(t){l.seq.define(r(),JSON.parse(t.value))},l.seq.play_element_text=function(t){if(l.seq.define(r(),JSON.parse(t.innerText)),document.selection&&document.selection.empty)document.selection.empty();else if(l.getSelection){var s=l.getSelection();s.removeAllRanges()}},l.seq.define=function(s,r){m.cmds.push(function(){return"string"===!(void 0===s?"undefined":e(s))?void console.log("error: missing sequence name"):Array.isArray(r)?new t(r,s).connect():void console.log("error: missing score data")})},l.seq.stop=function(t){if("string"==!(void 0===t?"undefined":e(t)))return void console.log("error: missing sequence name");var s=f[t];void 0!==s&&s.disconnect()},l.seq.external_resume=function(){var t=h.t+a*i;m.resume(t);for(var s in f)f[s].resume(t)},t.prototype.connect=function(){return Gibberish.sequencers.indexOf(this)===-1&&Gibberish.sequencers.push(this),Gibberish.dirty(this),this},t.prototype.disconnect=function(){var t=Gibberish.sequencers.indexOf(this);return t>=0&&Gibberish.sequencers.splice(t,1),delete f[this.name],this},t.prototype.tick=function(){h.linked||this.resume(this.t+a*i)},t.prototype.fork=function(t,e,r){var a=new s(t,e,this.name,r);this.push(a)},t.prototype.push=function(t){if(this.empty())this.heap.push(t);else{for(var s=this.heap.length,e=this.heap[s-1];e&&e.t<=t.t;)s--,e=this.heap[s-1];this.heap.splice(s,0,t)}return this},t.prototype.empty=function(){return 0===this.heap.length},t.prototype.at=function(){if(!this.empty())return this.heap[this.heap.length-1].t};var y=1e4;return t.prototype.resume=function(t){for(y=1e4;!this.empty()&&t>=this.at()&&--y>0;){var s=this.heap.pop();s.resume(t)&&this.push(s)}return y<=0&&(console.error("PQ resume unbounded loop detected"),this.disconnect()),this.t=t,this},s.prototype.get=function(t){for(var s=this,e=s.context[t];void 0==e&&s.parentQ;)s=s.parentQ,e=s.context[t];return e},s.prototype.push=function(t){this.todo.push(t)},s.prototype.step=function(){if(this.debug&&(console.log("\tstack:",JSON.stringify(this.stack)),console.log("\tqueue:",JSON.stringify(this.todo))),!this.todo.length)return!0;var t=this.todo.pop();if(null==t||void 0==t);else if(Array.isArray(t))for(x=t.length-1;x>=0;x--)this.todo.push(t[x]);else if("string"==typeof t&&"@"==t.charAt(0)){var s=t;if("@ws-"==s.substring(0,4)){var e=Number(s.substring(4)),r=this.stack.splice(this.stack.length-e,e),i=r.join(" ");return void ws_send(this.t+" "+i)}if("@gb-"==s.substring(0,4)){var e=Number(s.substring(4)),r=this.stack.splice(this.stack.length-e,e),i=r.join(" ");return void ws_send(i)}if("@let-"==s.substring(0,5)){var h=s.substring(5);return void(this.context[h]=this.stack.pop())}if("@set-"==s.substring(0,5)){var h=s.substring(5),l=this.stack.pop();if(!this.parentQ)return void(this.context[h]=l);for(var m=this,y=void 0;m&&(y=m.context,void 0==m.context[h]);)m=m.parentQ;return void(y[h]=l)}if("@get-"==s.substring(0,5)){var h=s.substring(5);return void this.stack.push(this.get(h))}switch(s){case"@dup":this.stack.push(this.stack[this.stack.length-1]);break;case"@bpm":var g=this.stack.pop();g=void 0==g?100:Math.abs(Number(g)),g=g==g?g:100,a=g;break;case"@wait":var g=this.stack.pop();g=void 0==g?1:Math.abs(Number(g)),g=g==g?g:0,this.t+=g*this.rate;break;case"@set-rate":var q=this.stack.pop();void 0!==q&&"number"==typeof q&&q>0?this.rate=q:console.error("missing or invalid argument to @rate");break;case"@with-rate":var q=this.stack.pop();if(void 0!==q&&"number"==typeof q&&q>0){var A=this.todo.pop();if(!Array.isArray(A)){console.error("with-rate body must be a pattern (an array)");break}this.push(["@set-rate",this.rate]),this.push(A),this.rate/=q}else console.error("missing or invalid argument to @rate");break;case"@spawn":var h=this.stack.pop(),A=this.todo.pop();if("string"!=typeof h&&"number"!=typeof h){console.error("spawn name must be a string or number");break}if(!Array.isArray(A)){console.error("spawn body must be a pattern (an array)");break}var w=f[this.pq];if(void 0==w){console.error("can't spawn, can't find sequencer",this.pq);break}var I=v[h];if(void 0==I)I=["@forever",A],v[h]=I,w.fork(I,this.t,this);else{var M=I[1];M.length=0,M.push.apply(M,A)}break;case"@stop":var h=this.stack.pop(),I=v[h];void 0!==I&&(console.log("stop",h),I[1].length=0,I.length=0,delete v[h]);break;case"@fork":var A=this.todo.pop();if(!Array.isArray(A)){console.error("loop body must be a pattern (an array)");break}var w=f[this.pq];w?w.fork(A,this.t,this):console.error("can't fork without a scheduler, couldn't find scheduler",this.pq);break;case"@loop":var A=this.todo.pop();if(!Array.isArray(A)){console.error("loop body must be a pattern (an array)");break}var w=f[this.pq];w?w.fork(["@forever",A],this.t,this):console.error("can't fork without a scheduler, couldn't find scheduler",this.pq);break;case"@forever":var A=this.todo[this.todo.length-1];if(!Array.isArray(A)){console.error("loop body must be a pattern (an array)");break}A.length&&(this.todo.push(t),this.todo.push(A));break;case"@repeat":var N=this.stack.pop(),A=this.todo[this.todo.length-1];if(!Array.isArray(A)){console.error("loop body must be a pattern (an array)");break}for(x=1;x<N;x++)this.todo.push(A);break;case"@print":console.log("PRINT!",this.stack.pop());break;case"@pick":if(Array.isArray(this.todo[this.todo.length-1])){var G=this.todo.pop(),x=random(G.length);x>=0&&this.todo.push(G[x])}else console.error("pick requires a list (array) argument to select from");break;case"@iter":var A=this.todo.pop();if(!Array.isArray(A)||!A.length){console.error("rotate instruction requires a pattern (array)");break}var S=A.splice(0,1);this.todo.push(S),A.push(S);break;case"@chance":var D=this.stack.pop(),_=this.todo.pop();random()<D&&(this.todo.pop(),this.todo.push(_));break;case"@reverse":if(!Array.isArray(this.todo[this.todo.length-1])){console.error("reverse instruction requires a pattern (array)");break}var Q=this.todo.pop();this.todo.push(Q.slice()),Q.reverse();break;case"@shuffle":if(!Array.isArray(this.todo[this.todo.length-1])){console.error("shuffle instruction requires a pattern (array)");break}var A=this.todo.pop();this.todo.push(A.slice()),array_shuffle(A);break;case"@rotate":var A=this.todo.pop(),O=this.stack.pop();if(!Array.isArray(A)||!A.length){console.error("rotate instruction requires a pattern (array)");break}O%=A.length;var T=A.splice(0);A.push.apply(A,T.slice(O)),A.push.apply(A,T.slice(0,O)),this.todo.push(T);break;case"@pre-rotate":var A=this.todo.pop(),O=this.stack.pop();if(!Array.isArray(A)||!A.length){console.error("rotate instruction requires a pattern (array)");break}O%=A.length;var T=A.splice(0);A.push.apply(A,T.slice(O)),A.push.apply(A,T.slice(0,O)),this.todo.push(A);break;case"@":case"@execute":var J=this.stack.pop();if("string"!=typeof J){console.error("execute instruction did not evaluate to a string");break}this.todo.push("@"+J);break;case"@cond":var P=this.stack.pop(),_=this.todo.pop();P&&(this.todo.pop(),this.todo.push(_));break;case"@random":case"@rand":this.stack.push(Math.random());break;case"@srandom":case"@srand":this.stack.push(2*Math.random()-1);break;case"@randi":var e=this.stack.pop();this.stack.push(random(e));break;case"@+":case"@add":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V+R);break;case"@-":case"@sub":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V-R);break;case"@*":case"@mul":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V*R);break;case"@/":case"@div":var R=this.stack.pop(),V=this.stack.pop();0==R?this.stack.push(0):this.stack.push(V/R);break;case"@%":case"@wrap":var R=this.stack.pop(),V=this.stack.pop();0==R?this.stack.push(0):this.stack.push(wrap(V,R));break;case"@mod":var R=this.stack.pop(),V=this.stack.pop();0==R?this.stack.push(0):this.stack.push(V%R);break;case"@neg":var V=this.stack.pop();this.stack.push(-V);break;case"@>":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V>R);break;case"@>=":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V>=R);break;case"@<":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V<R);break;case"@<=":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V<=R);break;case"@==":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V==R);break;case"@!=":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V!=R);break;case"@!":case"@not":var V=this.stack.pop();this.stack.push(!V);break;case"@&&":case"@and":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V&&R);break;case"@||":case"@or":var R=this.stack.pop(),V=this.stack.pop();this.stack.push(V||R);break;case"@map":var j=this.stack.pop(),K=this.stack.pop(),B=this.stack.pop(),C=this.stack.pop(),H=this.stack.pop();B==C?this.stack.push(K):this.stack.push(K+(H-C)/(B-C)*(j-K));break;case"@note-on":var z=Number(this.stack.pop()),E=Number(this.stack.pop()),F=Number(this.stack.pop());MIDI&&MIDI.send([144+z,F,E],0);break;case"@note-off":var z=Number(this.stack.pop()),E=Number(this.stack.pop()),F=Number(this.stack.pop());MIDI&&MIDI.send([128+z,F,E],0);break;case"@note":var L=Number(this.stack.pop()),z=Number(this.stack.pop()),E=Number(this.stack.pop()),F=Number(this.stack.pop());if(MIDI){MIDI.send([144+z,F,E],0);var w=f[this.pq];if(void 0==w)break;w.fork([F,0,z,"@note-off"],this.t+L*this.rate,this)}break;case"@cc":var z=Number(this.stack.pop()),l=Number(this.stack.pop()),U=Number(this.stack.pop());MIDI&&MIDI.send([176+z,U,l],0);break;case"@pluck":var W=this.get("amp"),X=this.get("freq");if(X<=0)break;b.damping=1- -6/Math.log(X/o),b.note(X,W*W*2);break;case"@pluck-note":var W=this.stack.pop(),X=this.stack.pop();if(X<=0)break;b.damping=1- -6/Math.log(X/o),b.note(X,W*W*2);break;case"@bass":var Y=this.get("amp"),X=this.get("freq");if(X<=0)break;d.note(X,Y);break;case"@bass-note":var Y=this.stack.pop(),X=this.stack.pop();if(X<=0)break;d.note(X,Y);break;case"@kick-note":p.amp=.5*this.stack.pop(),p.note();break;case"@snare-note":n.amp=.25*this.stack.pop(),n.note();break;case"@hat-note":c.amp=this.stack.pop(),c.note();break;case"@conga-note":u.amp=.25*this.stack.pop(),u.pitch=this.stack.pop(),u.note();break;case"@tom-note":k.amp=.25*this.stack.pop(),k.pitch=this.stack.pop(),k.note();break;case"@kick":p.amp=.5*this.get("amp"),p.note();break;case"@snare":n.amp=.25*this.get("amp"),n.note();break;case"@hat":c.amp=this.get("amp"),c.note();break;case"@conga":u.amp=.25*this.get("amp"),u.pitch=this.get("freq"),u.note();break;case"@tom":k.amp=.25*this.get("amp"),k.pitch=this.get("freq"),k.note();break;case"@time":this.stack.push(this.t);break;case"@rate":this.stack.push(this.rate);break;default:console.error("unknown instruction operator:",s)}}else this.stack.push(t)},s.prototype.resume=function(t){for(;--y>0&&this.todo.length&&this.t<t;)this.step();return this.todo.length>0},s.prototype.flush=function(){for(;--y>0&&this.todo.length;)this.step();0==y&&console.error("Q flush unbounded loop detected")},Gibberish.getSeq=function(){return l.seq},l}();
//# sourceMappingURL=ScheddVM.js.map
